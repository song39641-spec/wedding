<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wedding Moments - å©šç¦®ç›¸ç‰‡åˆ†äº«</title>
    <!-- å¼•å…¥å½©å¸¶ç‰¹æ•ˆåº« -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- å¼•å…¥ JSZip åº«ä¾†æ‰“åŒ…ä¸‹è¼‰æª”æ¡ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap');

        body { 
            font-family: 'Noto Serif TC', serif; 
            background-color: #fdfaf6; 
            color: #333; 
            overflow-x: hidden; 
            min-height: 100vh;
        }
        
        body.locked { overflow: hidden; background-color: #0c0c0c; }
        .gradient-bg { background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%); }
        
        /* --- è³“å®¢ç«¯æ°£æ³¡æµ®å‹• --- */
        @keyframes mobile-float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(3deg); }
        }
        
        .floating-item {
            position: absolute; 
            display: flex; flex-direction: column; align-items: center;
            width: 80px; 
            animation: mobile-float 4s ease-in-out infinite;
            transition: opacity 0.5s;
        }
        
        .delay-0 { animation-delay: 0s; }
        .delay-1 { animation-delay: -1s; }
        .delay-2 { animation-delay: -2.5s; }
        .delay-3 { animation-delay: -1.5s; }

        .floating-item img {
            width: 100%; height: 100%; aspect-ratio: 1/1; border-radius: 50%; object-fit: cover;
            border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .floating-item .msg-tag {
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 8px; border-radius: 12px; font-size: 10px; color: #333;
            white-space: nowrap; max-width: 100px; overflow: hidden; text-overflow: ellipsis;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: bold; margin-top: -5px; z-index: 2;
        }

        /* --- Dashboard å‹•ç•«ç³»çµ± --- */
        @keyframes wall-drift {
            0% { transform: translate(0, 0); }
            50% { transform: translate(var(--mx), var(--my)); }
            100% { transform: translate(0, 0); }
        }
        @keyframes wall-swing {
            0% { transform: rotate(calc(var(--r) - 1deg)); }
            50% { transform: rotate(calc(var(--r) + 1deg)); }
            100% { transform: rotate(calc(var(--r) - 1deg)); }
        }
        @keyframes pop-in {
            0% { opacity: 0; transform: scale(0.3) translateY(50px); }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        .wall-wrapper {
            position: absolute; z-index: 10; opacity: 0;
            animation: wall-drift 12s ease-in-out infinite;
            transition: opacity 1s ease-in-out;
        }
        .wall-wrapper.active { opacity: 1; }
        
        .wall-card {
            background: white; padding: 12px 12px 16px 12px;
            box-shadow: 0 15px 45px rgba(0,0,0,0.3); border-radius: 8px;
            display: flex; flex-direction: column; max-width: 280px;
            animation: wall-swing 6s ease-in-out infinite;
            transform-origin: center center;
        }
        .wall-wrapper.active .wall-card {
            animation: pop-in 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards,
                       wall-swing 6s ease-in-out infinite 0.6s;
        }
        @media (min-width: 768px) { .wall-card { max-width: 320px; padding: 16px 16px 20px 16px; border-radius: 12px; } }
        
        .wall-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 4px; margin-bottom: 8px; background-color: #f3f4f6; }
        .card-message {
            color: #444; font-family: 'Caveat', serif; font-size: 1.5rem; line-height: 1.2; text-align: center;
            min-height: 1.2em; display: flex; align-items: center; justify-content: center;
            word-break: break-all; font-weight: 700;
        }

        /* æ˜Ÿç©ºèƒŒæ™¯ */
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 10px rgba(255, 255, 255, 0.8); }
        }
        .bg-star {
            position: absolute; background: white; border-radius: 50%;
            animation: twinkle infinite ease-in-out;
        }

        /* æŠ½çæ¨¡å¼æ¨£å¼ */
        #draw-overlay {
            display: none; position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            flex-direction: column; align-items: center; justify-content: center;
        }
        
        #draw-title {
            font-size: 2.5rem; color: #fbc2eb; text-shadow: 0 0 20px rgba(251, 194, 235, 0.8);
            margin-bottom: 1.5rem; font-weight: bold; letter-spacing: 0.2em; text-align: center;
        }
        @media (min-width: 768px) { #draw-title { font-size: 4rem; } }

        /* 6 äººç¶²æ ¼æ’ç‰ˆ */
        .winners-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; 
            justify-content: center; align-items: center; width: 100%; max-width: 1000px; padding: 10px;
        }
        @media (min-width: 768px) { 
            .winners-grid { grid-template-columns: repeat(3, 1fr); gap: 25px; } 
        }

        .winner-card {
            background: white; padding: 10px 10px 35px 10px; border-radius: 8px;
            transform: scale(0); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 40px rgba(255,215,0, 0.4); border: 3px solid gold;
            width: 100%; position: relative;
        }
        .winner-card.reveal { transform: scale(1); }
        .winner-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 4px; }
        .winner-rank {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            background: gold; color: #d32f2f; font-weight: bold; padding: 4px 15px;
            border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-size: 0.9rem;
            white-space: nowrap; z-index: 20;
        }
        .winner-msg {
            position: absolute; bottom: 8px; left: 0; right: 0; text-align: center;
            color: #333; font-family: 'Caveat', serif; font-size: 1.3rem; font-weight: bold;
        }

        @keyframes slot-machine {
            0% { transform: translateY(-5px); opacity: 0.5; }
            50% { transform: translateY(5px); opacity: 1; }
            100% { transform: translateY(-5px); opacity: 0.5; }
        }
        .shuffling .winner-card { animation: slot-machine 0.1s infinite; border-color: #fff; box-shadow: none; }

        /* å°ˆå±¬ï¼šæŠ½çå®Œæˆå¾Œçš„æ­å–œåœ–ç‰‡ Popup */
        #congrats-popup {
            position: absolute; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.75); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.8s ease;
        }
        #congrats-popup.show { opacity: 1; pointer-events: auto; }
        #congrats-popup img {
            max-width: 90%; max-height: 85%; object-fit: contain;
            border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            transform: scale(0.5); transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #congrats-popup.show img { transform: scale(1); }

        #custom-modal, #confirm-modal { display: none; }
        .message-input {
            background: #fff; border: 2px solid #eee;
            color: #333; font-family: 'Noto Serif TC', serif;
        }
        .message-input:focus { outline: none; border-color: #fbc2eb; background: white; }
        
        .app-logo { animation: mobile-float 6s ease-in-out infinite; }
        
        /* æ›¿æ›ï¼šç§»é™¤ #audio-toggleï¼Œæ”¹ç”¨é–‹å ´è§£é–é®ç½© */
        #audio-unlock-overlay {
            position: fixed; inset: 0; z-index: 300;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; cursor: pointer; transition: opacity 0.8s ease;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="loading" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black">
        <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-pink-500 mb-4"></div>
        <p class="text-gray-400 text-sm">æ­£åœ¨è¼‰å…¥å¹¸ç¦é­”æ³•...</p>
    </div>

    <!-- è¨Šæ¯æç¤º -->
    <div id="custom-modal" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/50 p-6 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center text-gray-800">
            <h3 id="modal-title" class="text-xl font-bold mb-2 font-serif">æç¤º</h3>
            <p id="modal-body" class="text-gray-500 text-sm mb-6"></p>
            <button onclick="closeModal()" class="w-full py-3 bg-pink-500 text-white rounded-full font-bold shadow-lg">äº†è§£</button>
        </div>
    </div>

    <!-- ä¸Šå‚³ç¢ºèªè¦–çª— -->
    <div id="confirm-modal" class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-black/90 p-6 backdrop-blur-md">
        <div class="bg-white rounded-[2rem] p-6 max-w-sm w-full shadow-2xl flex flex-col items-center">
            <h3 class="text-xl font-bold text-gray-800 mb-2 font-serif">ğŸ“· ç¢ºèªä¸Šå‚³</h3>
            <p class="text-gray-400 text-xs mb-4">è«‹ç¢ºèªç…§ç‰‡èˆ‡ç¥ç¦èª</p>
            <div class="relative w-full rounded-xl overflow-hidden mb-4 shadow-inner bg-gray-100 border border-gray-200">
                <img id="confirm-preview-img" src="" class="w-full h-auto object-contain max-h-[300px] bg-gray-50 transition-transform duration-300">
                <!-- å·¦å³ç¿»è½‰æŒ‰éˆ• -->
                <button type="button" id="flip-image-btn" class="absolute top-2 right-2 bg-white/90 p-2 rounded-full shadow-md text-gray-700 hover:bg-gray-200 z-10 flex items-center gap-1 text-xs font-bold">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                    å·¦å³ç¿»è½‰
                </button>
            </div>
            <div class="w-full bg-pink-50 p-3 rounded-xl border border-pink-100 mb-6 text-center relative">
                <p class="text-xs text-pink-400 font-bold mb-1">æ‚¨çš„ç¥ç¦ (é»æ“Šå¯ä¿®æ”¹)</p>
                <input type="text" id="confirm-message-input" class="w-full bg-transparent text-center text-gray-700 font-serif font-bold text-lg border-b border-pink-200 focus:outline-none focus:border-pink-500 pb-1 placeholder-gray-300 pr-8" maxlength="20" placeholder="å¯«é»ä»€éº¼å§..." oninput="document.getElementById('confirm-char-count').innerText = this.value.length + '/20'">
                <span id="confirm-char-count" class="absolute bottom-3 right-3 text-[10px] text-pink-400 font-bold"></span>
            </div>
            <div class="grid grid-cols-2 gap-3 w-full">
                <button onclick="cancelUpload()" class="py-3 bg-gray-100 text-gray-600 rounded-2xl font-bold text-sm hover:bg-gray-200 transition-all">é‡é¸/ä¿®æ”¹</button>
                <button id="real-upload-btn" class="py-3 gradient-bg text-white rounded-2xl font-bold text-sm shadow-lg hover:opacity-90 transition-all flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    ç¢ºèªç™¼é€
                </button>
            </div>
        </div>
    </div>

    <!-- è³“å®¢ä»‹é¢ -->
    <div id="guest-view" class="hidden w-full max-w-md mx-auto px-6 py-8 flex flex-col min-h-screen">
        <header class="text-center mb-6">
            <div class="flex items-center justify-center gap-4">
                <span class="text-2xl font-bold text-gray-800 font-serif tracking-widest">Wedding</span>
                <img src="logo.jpg" onerror="this.style.display='none'" class="app-logo w-16 h-16 rounded-full border-4 border-white shadow-md object-cover">
                <span class="text-2xl font-bold text-gray-800 font-serif tracking-widest">Moments</span>
            </div>
            <p class="text-pink-400 text-xs font-bold tracking-[0.3em] mt-2 uppercase">Share Your Love</p>
        </header>

        <div class="bg-white p-6 rounded-[2rem] shadow-xl border border-white mb-6 relative z-10">
            <!-- æ‹ç…§ä»»å‹™ -->
            <div class="mb-6 rounded-2xl border border-pink-200 bg-pink-50 p-4 shadow-sm relative overflow-hidden">
                <div class="absolute -right-4 -top-4 w-20 h-20 bg-pink-100 rounded-full opacity-50"></div>
                <div class="flex items-center justify-between relative z-10">
                    <div class="text-left pr-2">
                        <span class="inline-block bg-pink-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full mb-2 shadow-sm animate-pulse">ğŸ“¸ ä»»å‹™ MISSION</span>
                        <p class="text-gray-700 text-sm font-bold leading-relaxed">
                            è«‹æ‹¿èµ·æ¡Œä¸Šçš„<br>
                            <span class="text-pink-600 text-lg">æ‡‰æ´æ‰‹ç‡ˆ</span> ğŸª„<br>
                            æ‹å¼µå¯æ„›è‡ªæ‹å§ï¼
                        </p>
                    </div>
                    <div class="w-24 h-32 flex-shrink-0 transform rotate-2 hover:rotate-0 transition-transform duration-300">
                        <img src="instruction.jpg" onerror="this.src='https://placehold.co/100x140/pink/white?text=Img'" class="w-full h-full object-cover rounded-xl border-4 border-white shadow-md">
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-end mb-2 ml-1 pr-1">
                    <label class="block text-gray-400 text-xs font-bold">ç•™ä¸‹ä¸€å¥ç¥ç¦ (é¸å¡«)</label>
                    <span id="char-count" class="text-[10px] text-pink-400 font-bold">0/20 å­—</span>
                </div>
                <textarea id="guest-message" rows="2" maxlength="20" placeholder="ä¾‹å¦‚ï¼šæ–°å©šå¿«æ¨‚ï¼ç™¾å¹´å¥½åˆ â¤ï¸" class="message-input w-full px-4 py-3 rounded-xl resize-none text-base shadow-sm" oninput="document.getElementById('char-count').innerText = this.value.length + '/20 å­—'"></textarea>
            </div>

            <div class="relative h-16 rounded-full gradient-bg shadow-lg flex items-center justify-center overflow-hidden active:scale-95 transition-transform cursor-pointer group">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="text-white font-bold text-lg font-serif">é–‹å•Ÿç›¸æ©Ÿä¸Šå‚³</span>
                </div>
                <input type="file" id="photo-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
            </div>
        </div>

        <div id="status-msg" class="text-center text-sm font-medium text-pink-600 mb-4 h-6"></div>
        
        <div class="flex-1 relative w-full min-h-[300px] mb-8">
            <div class="flex justify-between items-center mb-2 px-4">
                <h3 class="text-gray-400 text-xs font-bold tracking-widest">LIVE POOL</h3>
                <span class="text-[10px] text-gray-400 bg-white border border-gray-100 px-2 py-1 rounded-full">å³æ™‚æ›´æ–°</span>
            </div>
            <div id="physics-container" class="rounded-[2.5rem] bg-white w-full h-full absolute inset-0 overflow-hidden border border-gray-100 shadow-inner"></div>
        </div>
    </div>

    <!-- å¤§è¢å¹•æ’­æ”¾ (Dashboard Mode) -->
    <div id="dashboard-view" class="hidden fixed inset-0 overflow-hidden" style="background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);">
        <div id="dashboard-stars" class="absolute inset-0 z-0 pointer-events-none"></div>

        <!-- éŸ³æ•ˆè§£é–å…¨è¢å¹•é®ç½© -->
        <div id="audio-unlock-overlay">
            <p class="text-4xl md:text-6xl font-serif mb-6 animate-pulse tracking-widest text-pink-200">é»æ“Šè¢å¹•é–‹å§‹</p>
            <p class="text-gray-400 tracking-[0.3em] text-sm md:text-base uppercase">Click anywhere to start & unlock audio</p>
        </div>

        <!-- Dashboard Logo -->
        <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-0 text-white opacity-70 font-serif pointer-events-none flex flex-col items-center gap-2">
            <img src="logo.jpg" onerror="this.style.display='none'" class="w-16 h-16 rounded-full border-2 border-white/30 shadow-lg object-cover animate-pulse">
            <div class="text-center">
                <p class="text-xl md:text-2xl font-bold tracking-widest text-shadow-md">BLESSINGS</p>
                <p class="text-xs md:text-sm tracking-[0.4em] uppercase text-pink-200">Capture the Love</p>
            </div>
        </div>
        
        <div id="empty-state" class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
            <p class="text-white/20 text-2xl font-serif animate-pulse">ç­‰å¾…ç…§ç‰‡ä¸Šå‚³ä¸­...</p>
        </div>

        <div id="wall-container" class="relative w-full h-full z-10"></div>

        <!-- æŠ½çå±¤ -->
        <div id="draw-overlay">
            <h1 id="draw-title">LUCKY DRAW</h1>
            <!-- 6 å€‹å¡ç‰‡æ¬„ä½ -->
            <div class="winners-grid">
                <div class="winner-card" id="winner-1">
                    <div class="winner-rank">Winner 1</div>
                    <img src="https://placehold.co/300x300?text=?" alt="winner">
                    <div class="winner-msg">???</div>
                </div>
                <div class="winner-card" id="winner-2">
                    <div class="winner-rank">Winner 2</div>
                    <img src="https://placehold.co/300x300?text=?" alt="winner">
                    <div class="winner-msg">???</div>
                </div>
                <div class="winner-card" id="winner-3">
                    <div class="winner-rank">Winner 3</div>
                    <img src="https://placehold.co/300x300?text=?" alt="winner">
                    <div class="winner-msg">???</div>
                </div>
                <div class="winner-card" id="winner-4">
                    <div class="winner-rank">Winner 4</div>
                    <img src="https://placehold.co/300x300?text=?" alt="winner">
                    <div class="winner-msg">???</div>
                </div>
                <div class="winner-card" id="winner-5">
                    <div class="winner-rank">Winner 5</div>
                    <img src="https://placehold.co/300x300?text=?" alt="winner">
                    <div class="winner-msg">???</div>
                </div>
                <div class="winner-card" id="winner-6">
                    <div class="winner-rank">Winner 6</div>
                    <img src="https://placehold.co/300x300?text=?" alt="winner">
                    <div class="winner-msg">???</div>
                </div>
            </div>
            
            <!-- æ­å–œä¸­çè‡ªè¨‚åœ–ç‰‡ Popup (æŠ½çå®Œæˆå¾Œå½ˆå‡º) -->
            <div id="congrats-popup">
                <!-- éœ€å°‡åšå¥½çš„æ­å–œåœ–ç‰‡å‘½åç‚º congrats.jpg æ”¾åŒç›®éŒ„ -->
                <img src="congrats.jpg" onerror="this.src='https://placehold.co/800x600/pink/white?text=Congratulations!'" alt="æ­å–œä¸­ç">
            </div>
        </div>
    </div>

    <!-- ç®¡ç†ç«¯ -->
    <div id="admin-view" class="hidden w-full max-w-4xl mx-auto px-6 py-12 text-gray-800 pb-20">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-gray-200 pb-4 gap-4">
            <div>
                <h2 class="text-2xl font-bold font-serif text-red-600">ç…§ç‰‡ç®¡ç†å¾Œå°</h2>
                <p id="photo-count" class="text-gray-500 text-sm">çµ±è¨ˆä¸­...</p>
            </div>
            <div class="flex flex-wrap gap-2 justify-center">
                <!-- æ–°å¢ï¼šåŒ¯å‡ºå‚™ä»½æŒ‰éˆ• -->
                <button id="export-btn" onclick="window.exportData()" class="bg-green-500 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:bg-green-600 transform active:scale-95 transition-all">
                    ğŸ“¦ åŒ¯å‡ºå‚™ä»½
                </button>
                <!-- æ›´æ–°æŒ‰éˆ•æ–‡å­—ç‚º 6 ä½ -->
                <button onclick="window.startDraw()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:opacity-90 transform active:scale-95 transition-all">
                    ğŸ° æŠ½å‡º 6 ä½å¹¸é‹å…’
                </button>
                <button onclick="window.resetDraw()" class="bg-gray-200 text-gray-600 font-bold py-2 px-4 rounded-full hover:bg-gray-300">
                    ğŸ”„ æ¸…é™¤æŠ½ç
                </button>
            </div>
        </div>
        <div id="admin-gallery" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyBepjw82kk-gC0XzzzswLNDDJTGSjrPK54",
            authDomain: "wedding-moments-9ac34.firebaseapp.com",
            projectId: "wedding-moments-9ac34",
            storageBucket: "wedding-moments-9ac34.firebasestorage.app",
            messagingSenderId: "236760154456",
            appId: "1:236760154456:web:d0428c45c512d0f305a52d"
        };

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy, limit, setDoc, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const weddingId = 'wedding-app'; 
        const mode = new URLSearchParams(window.location.search).get('mode');

        onAuthStateChanged(auth, (user) => {
            if (!user) { signInAnonymously(auth); return; }
            document.getElementById('loading').classList.add('hidden');
            
            if (mode === 'admin') {
                showAdmin();
            } else if (mode === 'dashboard') {
                document.body.classList.add('locked');
                showDashboard();
            } else {
                showGuest();
            }
        });

        // --- éŸ³æ•ˆæ§åˆ¶å™¨ (é›™å¼•æ“ï¼šåˆæˆéŸ³æ•ˆ + å”¯ä¸€èƒŒæ™¯éŸ³æ¨‚) ---
        const AudioController = {
            ctx: null,
            drawMusic: new Audio('draw.mp3'), // å”¯ä¸€çš„è‡ªè¨‚èƒŒæ™¯éŸ³æ¨‚
            init: function() {
                // 1. åˆå§‹åŒ–åˆæˆéŸ³æ•ˆå¼•æ“ (æ‹‰éœ¸èˆ‡å®å’šè²)
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();

                // 2. é è¼‰å…¥éŸ³æ¨‚ä¸¦è§£é™¤ç€è¦½å™¨é™åˆ¶
                this.drawMusic.load();
                this.drawMusic.volume = 0.8; // è¨­å®šéŸ³é‡

                this.drawMusic.muted = true;
                this.drawMusic.play().then(() => {
                    this.drawMusic.pause();
                    this.drawMusic.muted = false;
                }).catch(e => console.log("è‡ªè¨‚éŸ³æ¨‚è§£é–ç­‰å¾…ä¸­"));
            },
            // --- ç¨‹å¼åˆæˆç‰¹æ•ˆéŸ³ ---
            playTick: function() {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.05);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.05);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.05);
            },
            playWin: function() {
                if (!this.ctx) return;
                const now = this.ctx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, now + i*0.1);
                    gain.gain.linearRampToValueAtTime(0.2, now + i*0.1 + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 1.5);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(now + i*0.1);
                    osc.stop(now + i*0.1 + 1.5);
                });
            },
            // --- è‡ªè¨‚ MP3 éŸ³æ¨‚æ§åˆ¶ ---
            startDrawMusic: function() {
                this.drawMusic.currentTime = 0;
                // è¨­å®š loop ç‚º falseï¼Œè®“å®ƒæ’­åˆ°å®Œå°±è‡ªç„¶åœæ­¢
                this.drawMusic.loop = false;
                this.drawMusic.play().catch(e => console.log("æ‰¾ä¸åˆ° draw.mp3 æª”æ¡ˆ"));
            },
            stopDrawMusic: function() {
                this.drawMusic.pause();
            }
        };

        window.showMessage = (title, body) => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerText = body;
            document.getElementById('custom-modal').style.display = 'flex';
        };
        window.closeModal = () => { document.getElementById('custom-modal').style.display = 'none'; };
        
        window.cancelUpload = () => {
            document.getElementById('confirm-modal').style.display = 'none';
            document.getElementById('photo-input').value = ''; 
            pendingFile = null;
            isImageFlipped = false;
            document.getElementById('confirm-preview-img').style.transform = 'scaleX(1)';
        };

        // å£“ç¸®å‡½æ•¸ (å«æ°´å¹³ç¿»è½‰)
        async function aggressiveResize(inputSource, targetSize = 700, flipH = false) {
            const getImg = (src) => new Promise((resolve) => {
                const img = new Image();
                if (src instanceof File) {
                    const r = new FileReader(); r.onload = (e) => img.src = e.target.result; r.readAsDataURL(src);
                } else { img.src = src; }
                img.onload = () => resolve(img);
            });
            const img = await getImg(inputSource);
            let q = 0.5; 
            const comp = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                if (w > targetSize || h > targetSize) {
                    if (w > h) { h *= targetSize/w; w = targetSize; } else { w *= targetSize/h; h = targetSize; }
                }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                
                // å¦‚æœéœ€è¦ç¿»è½‰ï¼Œèª¿æ•´ Canvas ç¹ªåœ–çŸ©é™£
                if (flipH) {
                    ctx.translate(w, 0);
                    ctx.scale(-1, 1);
                }
                
                ctx.drawImage(img, 0, 0, w, h);
                const b64 = canvas.toDataURL('image/jpeg', q);
                if (b64.length > 300000 && q > 0.1) { q -= 0.1; return comp(); }
                return b64;
            };
            return comp();
        }

        let pendingFile = null;
        let isImageFlipped = false; // è¿½è¹¤ç¿»è½‰ç‹€æ…‹

        function showGuest() {
            document.getElementById('guest-view').classList.remove('hidden');
            const container = document.getElementById('physics-container');
            const msgInput = document.getElementById('guest-message');

            const slots = [
                {x: 5, y: 5}, {x: 35, y: 5}, {x: 65, y: 5},
                {x: 5, y: 35}, {x: 35, y: 35}, {x: 65, y: 35},
                {x: 5, y: 65}, {x: 35, y: 65}, {x: 65, y: 65}
            ];

            let cachedPhotos = [];

            onSnapshot(query(collection(db, 'artifacts', weddingId, 'public', 'data', 'photos'), orderBy('timestamp', 'desc'), limit(20)), (s) => {
                cachedPhotos = s.docs.map(d => ({ id: d.id, ...d.data() }));
                let hasNew = false;
                s.docChanges().forEach(change => { if (change.type === "added") hasNew = true; });
                if (hasNew || container.children.length === 0) rotatePhotos(cachedPhotos);
            });

            setInterval(() => {
                if (cachedPhotos.length > 0) rotatePhotos(cachedPhotos);
            }, 60000);

            function rotatePhotos(allPhotos) {
                container.innerHTML = '';
                if (allPhotos.length === 0) return;
                const count = Math.min(allPhotos.length, 9);
                const latestCount = Math.min(allPhotos.length, 3);
                const latest = allPhotos.slice(0, latestCount);
                const others = allPhotos.slice(latestCount);
                const randomOthers = others.sort(() => 0.5 - Math.random()).slice(0, count - latestCount);
                const batch = [...latest, ...randomOthers];

                batch.forEach((photo, index) => {
                    const slot = slots[index];
                    const left = slot.x + (Math.random() * 10 - 5);
                    const top = slot.y + (Math.random() * 10 - 5);
                    const delay = `delay-${index % 4}`;

                    const el = document.createElement('div');
                    el.className = `floating-item ${delay}`;
                    el.style.left = `${left}%`;
                    el.style.top = `${top}%`;
                    el.innerHTML = `<img src="${photo.imageUrl}"><div class="msg-tag">${photo.message || "Happy Wedding!"}</div>`;
                    container.appendChild(el);
                });
            }

            const verifySelection = (file) => {
                if (!file) return;
                pendingFile = file; 
                
                // é‡ç½®ç¿»è½‰ç‹€æ…‹
                isImageFlipped = false;
                document.getElementById('confirm-preview-img').style.transform = 'scaleX(1)';
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('confirm-preview-img').src = e.target.result;
                    const msg = msgInput.value.trim() || "Happy Wedding! â¤ï¸";
                    document.getElementById('confirm-message-input').value = msg; 
                    document.getElementById('confirm-char-count').innerText = msg.length + '/20'; // æ›´æ–°ç¢ºèªè¦–çª—çš„å­—æ•¸
                    document.getElementById('confirm-modal').style.display = 'flex';
                };
                reader.readAsDataURL(file);
            };

            // ç¿»è½‰æŒ‰éˆ•äº‹ä»¶
            document.getElementById('flip-image-btn').onclick = () => {
                isImageFlipped = !isImageFlipped;
                document.getElementById('confirm-preview-img').style.transform = isImageFlipped ? 'scaleX(-1)' : 'scaleX(1)';
            };

            const executeUpload = async () => {
                if (!pendingFile) return;
                document.getElementById('confirm-modal').style.display = 'none';
                const status = document.getElementById('status-msg');
                const message = document.getElementById('confirm-message-input').value.trim() || "Happy Wedding! â¤ï¸"; 
                
                status.innerText = "ç…§ç‰‡è™•ç†ä¸Šå‚³ä¸­...";
                try {
                    // å°‡ç¿»è½‰ç‹€æ…‹å‚³å…¥è™•ç†ç¨‹åº
                    let b64 = await aggressiveResize(pendingFile, 700, isImageFlipped); 
                    await addDoc(collection(db, 'artifacts', weddingId, 'public', 'data', 'photos'), {
                        imageUrl: b64, message: message, timestamp: Date.now()
                    });
                    status.innerText = "ä¸Šå‚³æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„ç¥ç¦";
                    msgInput.value = ""; 
                    document.getElementById('char-count').innerText = "0/20 å­—"; // ä¸Šå‚³æˆåŠŸå¾Œæ­¸é›¶
                    document.getElementById('photo-input').value = ''; 
                    pendingFile = null;
                } catch (e) { showMessage("ä¸Šå‚³å¤±æ•—", e.message); status.innerText = ""; } 
                finally { setTimeout(() => status.innerText = "", 3000); }
            };

            document.getElementById('photo-input').onchange = (e) => verifySelection(e.target.files[0]);
            document.getElementById('real-upload-btn').onclick = executeUpload;
        }

        // --- å¤§è¢å¹•é‚è¼¯ ---
        function showDashboard() {
            document.getElementById('dashboard-view').classList.remove('hidden');
            const wall = document.getElementById('wall-container');
            const emptyState = document.getElementById('empty-state');
            const drawOverlay = document.getElementById('draw-overlay');
            const congratsPopup = document.getElementById('congrats-popup');
            const winnerCards = document.querySelectorAll('.winner-card');
            
            // éŸ³æ•ˆè§£é–é‚è¼¯ (é»æ“Šå…¨è¢å¹•é®ç½©è§£é–)
            const unlockOverlay = document.getElementById('audio-unlock-overlay');
            unlockOverlay.onclick = () => {
                AudioController.init();
                AudioController.playTick(); // æ’­æ”¾æ¥µçŸ­éŸ³æ•ˆå–šé†’ç€è¦½å™¨
                unlockOverlay.style.opacity = '0'; // æ·¡å‡ºé®ç½©
                setTimeout(() => unlockOverlay.style.display = 'none', 800); 
            };
            
            let allPhotos = [];
            let newPhotosQueue = []; 
            let isCycleStarted = false;
            
            let currentDrawTimestamp = 0; 
            let congratsTimeout1, congratsTimeout2;

            function createStarrySky() {
                const bg = document.getElementById('dashboard-stars');
                bg.innerHTML = ''; 
                for(let i=0; i<100; i++) {
                    const star = document.createElement('div');
                    star.className = 'bg-star';
                    const size = Math.random() * 3 + 1; 
                    star.style.width = `${size}px`; star.style.height = `${size}px`;
                    star.style.left = `${Math.random() * 100}%`; star.style.top = `${Math.random() * 100}%`;
                    star.style.animationDuration = `${Math.random() * 3 + 2}s`; 
                    star.style.animationDelay = `${Math.random() * 5}s`;
                    bg.appendChild(star);
                }
            }
            createStarrySky();

            onSnapshot(collection(db, 'artifacts', weddingId, 'public', 'data', 'photos'), (s) => {
                const currentData = s.docs.map(d => ({ id: d.id, ...d.data() }));
                s.docChanges().forEach(change => { if (change.type === "added") newPhotosQueue.push(change.doc.data()); });
                allPhotos = currentData;
                if (allPhotos.length > 0) {
                    emptyState.style.display = 'none';
                    if (!isCycleStarted) { startWallCycle(); isCycleStarted = true; }
                }
            });

            onSnapshot(doc(db, 'artifacts', weddingId, 'public', 'data', 'game', 'draw'), (docSnap) => {
                if (!docSnap.exists()) return;
                const data = docSnap.data();
                
                if (data.status === 'drawing') {
                    // é˜²é‡è¤‡è§¸ç™¼
                    if (currentDrawTimestamp === data.timestamp) return; 
                    currentDrawTimestamp = data.timestamp;

                    drawOverlay.style.display = 'flex';
                    drawOverlay.classList.add('shuffling'); 
                    
                    // é‡ç½®æ­å–œåœ–ç‰‡èˆ‡è¨ˆæ™‚å™¨
                    clearTimeout(congratsTimeout1);
                    clearTimeout(congratsTimeout2);
                    congratsPopup.classList.remove('show'); 
                    
                    winnerCards.forEach(card => card.classList.remove('reveal'));
                    
                    // 1. é–‹å§‹æ’­æ”¾è‡ªè¨‚èƒŒæ™¯éŸ³æ¨‚ (æœƒä¸€è·¯æ’­ä¸‹å»ä¸ä¸­æ–·)
                    AudioController.startDrawMusic();
                    
                    let shuffleInterval = setInterval(() => {
                        // åˆæˆçš„æ‹‰éœ¸æ»´ç­”è²
                        AudioController.playTick();
                        winnerCards.forEach(card => {
                            const randomPhoto = allPhotos[Math.floor(Math.random() * allPhotos.length)];
                            if(randomPhoto) card.querySelector('img').src = randomPhoto.imageUrl;
                        });
                    }, 100);
                    
                    setTimeout(() => {
                        clearInterval(shuffleInterval);
                        drawOverlay.classList.remove('shuffling');
                        
                        // ç§»é™¤é€™è£¡çš„ stopDrawMusic()ï¼Œè®“éŸ³æ¨‚ç¹¼çºŒæ”¾
                        
                        if (data.winners && data.winners.length === 6) {
                            data.winners.forEach((w, i) => {
                                const card = document.getElementById(`winner-${i+1}`);
                                if(!card) return;
                                card.querySelector('img').src = w.imageUrl;
                                card.querySelector('.winner-msg').innerText = w.message || "Lucky Winner!";
                                
                                setTimeout(() => {
                                    card.classList.add('reveal');
                                    // æ¯å¼µç‰Œç¿»é–‹æ™‚çš„åˆæˆç‰¹æ•ˆéŸ³
                                    AudioController.playWin();
                                    
                                    // ç•¶æœ€å¾Œä¸€ä½å¹¸é‹å…’æ­æ›‰æ™‚
                                    if(i === data.winners.length - 1) { 
                                        confetti({ particleCount: 300, spread: 120, origin: { y: 0.6 } });
                                        
                                        // å»¶é² 1.5 ç§’å¾Œï¼Œå½ˆå‡ºæ­å–œå°ˆå±¬åœ–ç‰‡
                                        congratsTimeout1 = setTimeout(() => {
                                            congratsPopup.classList.add('show');
                                            AudioController.playWin(); // å†æ’­æ”¾ä¸€æ¬¡å¤§çåˆæˆéŸ³æ•ˆ
                                            
                                            // å¼·åˆ¶ç¢ºä¿ 3.5 ç§’å¾Œè‡ªå‹•éš±è—
                                            congratsTimeout2 = setTimeout(() => {
                                                congratsPopup.classList.remove('show');
                                            }, 3500);
                                        }, 1500); 
                                    }
                                }, i * 600);
                            });
                        }
                    }, 5000);
                } else if (data.status === 'idle') {
                    if (currentDrawTimestamp === 0) return; 
                    currentDrawTimestamp = 0; 
                    
                    // åªæœ‰åœ¨å¾Œå°æŒ‰ä¸‹ã€Œæ¸…é™¤æŠ½çã€æ™‚ï¼Œæ‰æœƒåœæ­¢è‡ªè¨‚éŸ³æ¨‚
                    AudioController.stopDrawMusic();

                    drawOverlay.style.display = 'none';
                    clearTimeout(congratsTimeout1);
                    clearTimeout(congratsTimeout2);
                    congratsPopup.classList.remove('show');
                    winnerCards.forEach(card => card.classList.remove('reveal'));
                }
            });

            // ä¿®æ”¹æ­¤è™•ï¼šå°‡ 60000 æ¯«ç§’æ”¹ç‚º 15000 æ¯«ç§’ (15ç§’æ›ä¸€è¼ª)
            setInterval(() => { if(allPhotos.length > 0) startWallCycle(); }, 15000); 

            function startWallCycle() {
                Array.from(wall.children).forEach(child => {
                    child.classList.remove('active'); 
                    setTimeout(() => child.remove(), 1200);
                });
                
                const isMobile = window.innerWidth < 768;
                const cols = isMobile ? 2 : 4; 
                const count = Math.min(allPhotos.length, isMobile ? 4 : 8); 
                const cardBaseSize = isMobile ? 140 : 280;
                const sizeVar = isMobile ? 40 : 80;

                const sorted = [...allPhotos].sort((a,b) => b.timestamp - a.timestamp);
                const recent = sorted.slice(0, count/2);
                const others = sorted.slice(count/2).sort(() => 0.5 - Math.random());
                const displaySet = [...recent, ...others].slice(0, count);

                displaySet.forEach((photo, index) => {
                    const card = document.createElement('div');
                    card.className = `wall-wrapper`; 
                    
                    const size = Math.random() * sizeVar + cardBaseSize; 
                    const col = index % cols;
                    const row = Math.floor(index / cols);
                    
                    const colWidth = 100 / cols;
                    const rowHeight = isMobile ? 40 : 40; 
                    const left = col * colWidth + (Math.random() * 5); 
                    const top = row * rowHeight + (Math.random() * 10 + 5);
                    const rotate = (Math.random() * 16 - 8);
                    const mx = (Math.random() * 60 - 30)+'px', my = (Math.random()*60-30)+'px';
                    
                    card.style.width = `${size}px`; card.style.left = `${left}%`; card.style.top = `${top}%`;
                    card.style.setProperty('--r', `${rotate}deg`); card.style.setProperty('--mx', mx); card.style.setProperty('--my', my);
                    card.style.zIndex = index;
                    
                    card.innerHTML = `
                        <div class="wall-card">
                            <img src="${photo.imageUrl}">
                            <div class="card-message">${photo.message || "Happy Wedding!"}</div>
                        </div>
                    `;
                    wall.appendChild(card);
                    setTimeout(() => card.classList.add('active'), index * 100 + 50);
                });
            }
        }

        function showAdmin() {
            document.getElementById('admin-view').classList.remove('hidden');
            const countLabel = document.getElementById('photo-count');
            
            // æ–°å¢ï¼šåŒ¯å‡ºå‚™ä»½åŠŸèƒ½ (åŠ å·¥æˆæ‹ç«‹å¾—æ¨£å¼)
            window.exportData = async () => {
                const btn = document.getElementById('export-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = "â³ è£½ä½œæ‹ç«‹å¾—æ‰“åŒ…ä¸­...";
                btn.disabled = true;

                try {
                    const snapshot = await getDocs(collection(db, 'artifacts', weddingId, 'public', 'data', 'photos'));
                    if (snapshot.empty) {
                        alert("ç›®å‰æ²’æœ‰ç…§ç‰‡å¯ä»¥åŒ¯å‡ºï¼");
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        return;
                    }

                    const zip = new window.JSZip();
                    const photoFolder = zip.folder("Wedding_Photos");
                    let csvContent = "\uFEFFæª”æ¡ˆåç¨±,ç¥ç¦èª,ä¸Šå‚³æ™‚é–“\n"; 

                    // æº–å‚™ä¸€å€‹éš±è—çš„ Canvas ç”¨ä¾†ç•«æ‹ç«‹å¾—
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 800;
                    canvas.height = 1000; // æ‹ç«‹å¾—æ¯”ä¾‹

                    // ç­‰å¾…å­—é«”è¼‰å…¥ï¼Œç¢ºä¿åŒ¯å‡ºçš„å­—é«”è·Ÿå¤§è¢å¹•ä¸€æ¨£å¥½çœ‹
                    await document.fonts.ready;

                    const docs = snapshot.docs;
                    for (let i = 0; i < docs.length; i++) {
                        const data = docs[i].data();
                        const filename = `photo_${i + 1}.jpg`;
                        const date = new Date(data.timestamp).toLocaleString('zh-TW');
                        const msgText = data.message || "Happy Wedding!";
                        const msg = msgText.replace(/"/g, '""').replace(/\n/g, " "); 

                        csvContent += `"${filename}","${msg}","${date}"\n`;

                        if (data.imageUrl && data.imageUrl.includes('base64,')) {
                            // è¼‰å…¥åŸåœ–ç‰‡
                            const img = new Image();
                            await new Promise((resolve) => {
                                img.onload = resolve;
                                img.src = data.imageUrl;
                            });

                            // 1. ç•«ç™½è‰²èƒŒæ™¯ (æ‹ç«‹å¾—åº•ç´™)
                            ctx.fillStyle = "#ffffff";
                            ctx.fillRect(0, 0, canvas.width, canvas.height);

                            // 2. è¨ˆç®— 1:1 å®Œç¾ç½®ä¸­è£åˆ‡
                            const targetSize = 720;
                            let sWidth = img.width;
                            let sHeight = img.height;
                            let sx = 0, sy = 0;
                            if (sWidth > sHeight) {
                                sx = (sWidth - sHeight) / 2;
                                sWidth = sHeight;
                            } else {
                                sy = (sHeight - sWidth) / 2;
                                sHeight = sWidth;
                            }
                            
                            // 3. æŠŠç…§ç‰‡å°ä¸Šå» (ç•™ç™½é‚Š)
                            ctx.drawImage(img, sx, sy, sWidth, sHeight, 40, 40, targetSize, targetSize);

                            // 4. åœ¨åº•éƒ¨ç•«ä¸Šç•™è¨€æ–‡å­—
                            ctx.fillStyle = "#444444";
                            ctx.textAlign = "center";
                            ctx.textBaseline = "middle";
                            ctx.font = "bold 40px 'Caveat', 'Noto Serif TC', serif";
                            
                            // æœ€å¤šå¯¬åº¦ 720pxï¼Œé¿å…å­—å¤ªé•·è·‘å‡ºç›¸ç´™
                            ctx.fillText(msgText, canvas.width / 2, 880, 720);

                            // 5. å°‡ç•«å¥½çš„æ‹ç«‹å¾—è½‰æˆ JPEG æ”¾é€²å£“ç¸®æª”
                            const newBase64 = canvas.toDataURL("image/jpeg", 0.9).split(',')[1];
                            photoFolder.file(filename, newBase64, {base64: true});
                        }
                    }

                    zip.file("ç¥ç¦ç•™è¨€æ¸…å–®.csv", csvContent);

                    // ç”¢ç”Ÿå£“ç¸®æª”ä¸¦è§¸ç™¼ä¸‹è¼‰
                    const blob = await zip.generateAsync({type: "blob"});
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "Wedding_Moments_Backup.zip";
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                } catch (error) {
                    alert("åŒ¯å‡ºå¤±æ•—ï¼š" + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            };
            
            window.startDraw = async () => {
                const snapshot = await getDocs(collection(db, 'artifacts', weddingId, 'public', 'data', 'photos'));
                const photos = snapshot.docs.map(d => d.data());
                
                if (photos.length < 6) { 
                    alert(`ç›®å‰åªæœ‰ ${photos.length} å¼µç…§ç‰‡ï¼Œä¸è¶³ 6 å¼µï¼Œç„¡æ³•æŠ½çï¼`); 
                    return; 
                }
                
                const shuffled = photos.sort(() => 0.5 - Math.random());
                const winners = shuffled.slice(0, 6);
                
                await setDoc(doc(db, 'artifacts', weddingId, 'public', 'data', 'game', 'draw'), {
                    status: 'drawing', winners: winners, timestamp: Date.now()
                });
            };
            
            window.resetDraw = async () => {
                await setDoc(doc(db, 'artifacts', weddingId, 'public', 'data', 'game', 'draw'), {
                    status: 'idle', timestamp: Date.now()
                });
            };
            
            onSnapshot(collection(db, 'artifacts', weddingId, 'public', 'data', 'photos'), (s) => {
                const gal = document.getElementById('admin-gallery'); gal.innerHTML = '';
                countLabel.innerText = `ç›®å‰å…±æœ‰ ${s.size} å¼µç…§ç‰‡`;
                s.docs.forEach(d => {
                    const data = d.data();
                    const div = document.createElement('div'); div.className = 'relative group';
                    div.innerHTML = `<div class="bg-gray-100 p-2 rounded-xl h-full flex flex-col"><img src="${data.imageUrl}" class="w-full h-32 object-cover rounded-lg mb-2"><p class="text-xs text-gray-500 truncate text-center">${data.message || 'ç„¡ç•™è¨€'}</p><button class="mt-2 bg-red-500 text-white text-xs py-1 rounded hover:bg-red-600 w-full" onclick="window.del('${d.id}')">åˆªé™¤</button></div>`;
                    gal.appendChild(div);
                });
            });
            window.del = (id) => { if(confirm('ç¢ºå®šåˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ')) deleteDoc(doc(db, 'artifacts', weddingId, 'public', 'data', 'photos', id)); };
        }
    </script>
</body>
</html>