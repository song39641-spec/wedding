<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wedding Moments - AI é­”æ³•ç›¸é¤¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Serif TC', serif; background-color: #fdfaf6; overflow-x: hidden; }
        .gradient-bg { background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%); }
        .ai-gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        @keyframes float-star {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            50% { transform: translate(15px, -20px) rotate(3deg) scale(1.05); }
            100% { transform: translate(0, 0) rotate(0deg) scale(1); }
        }
        
        .floating-photo {
            position: absolute; border-radius: 50%; object-fit: cover; border: 4px solid white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); animation: float-star 10s ease-in-out infinite;
            transition: opacity 1s ease;
        }
        
        #star-container { position: relative; width: 100%; height: 420px; overflow: hidden; background: #fffdfb; border-top: 1px solid #eee; }
        .photo-card { box-shadow: 0 30px 60px rgba(0,0,0,0.4); border: 15px solid white; border-bottom: 60px solid white; }
        
        /* è‡ªå®šç¾©å½ˆçª— */
        #custom-modal { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- ç‹€æ…‹é®ç½© -->
    <div id="loading" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white">
        <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-pink-500 mb-4"></div>
        <p class="text-gray-400 text-sm">æº–å‚™å¹¸ç¦ä¸­...</p>
    </div>

    <!-- AI è™•ç†ä¸­ -->
    <div id="ai-processing" class="hidden fixed inset-0 z-[110] flex flex-col items-center justify-center bg-black/85 backdrop-blur-md text-center px-8">
        <div class="animate-bounce mb-6"><div class="w-16 h-16 rounded-full ai-gradient-bg shadow-2xl"></div></div>
        <h2 id="ai-status-msg" class="text-white text-xl font-bold mb-2">æ­£åœ¨åˆ†æç…§ç‰‡...</h2>
        <p class="text-white/50 text-sm">æ­£åœ¨æ–½æ”¾é­”æ³•ï¼Œè«‹ç¨å€™ 10-15 ç§’</p>
    </div>

    <!-- éŒ¯èª¤/æˆåŠŸè¨Šæ¯æç¤ºæ¡† -->
    <div id="custom-modal" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/50 p-6 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center">
            <div id="modal-icon" class="mb-4 text-4xl">âš ï¸</div>
            <h3 id="modal-title" class="text-xl font-bold mb-2">æç¤º</h3>
            <p id="modal-body" class="text-gray-500 text-sm mb-6"></p>
            <button onclick="closeModal()" class="w-full py-3 bg-gray-900 text-white rounded-full font-bold">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- è³“å®¢ä»‹é¢ -->
    <div id="guest-view" class="hidden w-full max-w-md px-6 py-10">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-800 font-serif">Wedding Moments</h1>
            <p class="text-pink-400 text-xs font-bold tracking-widest mt-1 uppercase">AI Magic Studio</p>
        </header>

        <div class="space-y-5 mb-10">
            <div class="relative h-24 rounded-[2rem] gradient-bg border-4 border-white shadow-lg flex items-center justify-center active:scale-95 transition-transform overflow-hidden">
                <span class="text-white font-bold text-lg">ä¸€èˆ¬åˆ†äº«ç…§ç‰‡</span>
                <input type="file" id="photo-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
            </div>
            <div class="relative h-24 rounded-[2rem] ai-gradient-bg border-4 border-white shadow-xl flex items-center justify-center active:scale-95 transition-transform overflow-hidden">
                <div class="text-center">
                    <span class="text-white font-bold text-lg block">AI å¹»å½±åˆç…§</span>
                    <span class="text-white/60 text-[10px]">èˆ‡æ–°äººç©¿è¶Šåˆå½±</span>
                </div>
                <input type="file" id="ai-photo-input" accept="image/*" capture="user" class="absolute inset-0 opacity-0 cursor-pointer">
            </div>
        </div>

        <div id="status-msg" class="text-center text-sm font-medium text-pink-600 mb-6 h-4 italic"></div>
        <div id="star-container" class="rounded-[2.5rem] shadow-inner"></div>
    </div>

    <!-- ç®¡ç†å“¡ä»‹é¢ -->
    <div id="admin-view" class="hidden w-full max-w-4xl px-6 py-10">
        <div class="bg-white p-8 rounded-3xl shadow-xl mb-10 border-2 border-pink-50">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 font-serif">1. è¨­å®šæ–°äººåŸºåº•ç…§</h2>
                <button id="test-api-btn" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-full text-xs font-bold">ğŸ” æ¸¬è©¦ API é€£ç·š</button>
            </div>
            <div class="flex flex-col md:flex-row items-center gap-8">
                <div id="base-preview" class="w-56 h-56 bg-gray-50 rounded-2xl overflow-hidden border-2 border-dashed border-gray-200 flex items-center justify-center shadow-inner">
                    <span class="text-gray-400 text-sm">å°šæœªè¨­å®š</span>
                </div>
                <div class="flex-1 space-y-4">
                    <input type="file" id="base-input" accept="image/*" class="block w-full text-sm">
                    <p class="text-[10px] text-amber-600 leading-tight font-sans uppercase">
                        â€» æˆ‘å€‘å·²å°‡åœ–ç‰‡è‡ªå‹•é™åˆ¶åœ¨ 1MB ä»¥å…§ï¼Œè‹¥ä»å¤±æ•—è«‹æ›´æ›ä¸€å¼µèƒŒæ™¯è¼ƒç°¡å–®çš„ç…§ç‰‡ã€‚
                    </p>
                    <button id="save-base-btn" class="hidden w-full py-4 bg-pink-500 text-white rounded-full font-bold shadow-lg">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>
        <div id="admin-gallery" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
    </div>

    <!-- å¤§è¢å¹•æ¨¡å¼ -->
    <div id="dashboard-view" class="hidden fixed inset-0 bg-neutral-950 flex items-center justify-center text-white">
        <div id="slideshow-container" class="relative w-full h-full flex items-center justify-center"></div>
    </div>

    <script type="module">
        // --- æ ¸å¿ƒé…ç½® (è«‹ç¢ºä¿æ­¤ KEY å‰›æ–°ç”³è«‹ä¸”æœªå¤–æ´©) ---
        const apiKey = "AIzaSyA-J7lLFQ8qdtVcXifkEhtraDgymBlS3a8"; 

        const firebaseConfig = {
            apiKey: "AIzaSyBepjw82kk-gC0XzzzswLNDDJTGSjrPK54",
            authDomain: "wedding-moments-9ac34.firebaseapp.com",
            projectId: "wedding-moments-9ac34",
            storageBucket: "wedding-moments-9ac34.firebasestorage.app",
            messagingSenderId: "236760154456",
            appId: "1:236760154456:web:d0428c45c512d0f305a52d"
        };

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const weddingId = 'wedding-app'; 

        const mode = new URLSearchParams(window.location.search).get('mode');

        onAuthStateChanged(auth, (user) => {
            if (!user) { signInAnonymously(auth); return; }
            document.getElementById('loading').classList.add('hidden');
            if (mode === 'admin') showAdmin();
            else if (mode === 'dashboard') showDashboard();
            else showGuest();
        });

        // --- å…¨åŸŸè¨Šæ¯å½ˆçª—åŠŸèƒ½ ---
        window.showMessage = (title, body, icon = "âš ï¸") => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerText = body;
            document.getElementById('modal-icon').innerText = icon;
            document.getElementById('custom-modal').style.display = 'flex';
        };
        window.closeModal = () => { document.getElementById('custom-modal').style.display = 'none'; };

        // --- ä¿®æ­£å¾Œçš„ AI èåˆé‚è¼¯ ---
        async function runAI(guestB64) {
            const statusMsg = document.getElementById('ai-status-msg');
            const snap = await getDoc(doc(db, 'artifacts', weddingId, 'public', 'data', 'settings', 'couplePhoto'));
            if (!snap.exists()) throw new Error("å°šæœªä¸Šå‚³æ–°äººåˆç…§");
            
            // æ­¥é©Ÿä¸€ï¼šåˆ†æ (ä½¿ç”¨ç©©å®šçš„ gemini-1.5-flash)
            statusMsg.innerText = "æ­£åœ¨è®€å–å…©äººç‰¹å¾µ...";
            const analysisPayload = {
                contents: [{
                    parts: [
                        { text: "This is a wedding couple(Image 1) and a guest(Image 2). Describe a high-quality prompt in English to blend the guest into the same wedding scene standing beside the couple. Output ONLY the prompt." },
                        { inlineData: { mimeType: "image/jpeg", data: snap.data().imageUrl.split(',')[1] } },
                        { inlineData: { mimeType: "image/jpeg", data: guestB64.split(',')[1] } }
                    ]
                }]
            };

            const res1 = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(analysisPayload)
            });
            const data1 = await res1.json();
            if (!res1.ok) throw new Error("åˆ†æéšæ®µå¤±æ•—: " + (data1.error?.message || "æœªçŸ¥åŸå› "));
            const prompt = data1.candidates[0].content.parts[0].text;

            // æ­¥é©ŸäºŒï¼šç”Ÿæˆ (ä½¿ç”¨ imagen-3.0-generate-001)
            statusMsg.innerText = "æ­£åœ¨ç¹ªè£½å¤¢å¹»åˆç…§...";
            const genRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ instances: [{ prompt: prompt }], parameters: { sampleCount: 1 } })
            });
            const data2 = await genRes.json();
            if (!genRes.ok) throw new Error("ç”Ÿæˆéšæ®µå¤±æ•—ï¼Œè«‹ç¢ºèª Imagen æ¨¡å‹æ¬Šé™å·²é–‹å•Ÿã€‚");
            
            return `data:image/png;base64,${data2.predictions[0].bytesBase64Encoded}`;
        }

        // --- è³“å®¢åŠŸèƒ½ ---
        function showGuest() {
            document.getElementById('guest-view').classList.remove('hidden');
            const container = document.getElementById('star-container');
            
            onSnapshot(collection(db, 'artifacts', weddingId, 'public', 'data', 'photos'), (s) => {
                const photos = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>b.timestamp-a.timestamp).slice(0,12);
                const ids = Array.from(container.querySelectorAll('img')).map(i => i.dataset.id);
                photos.forEach(p => {
                    if (!ids.includes(p.id)) {
                        const img = document.createElement('img');
                        img.src = p.imageUrl; img.dataset.id = p.id; img.className = 'floating-photo';
                        const sz = Math.random()*40+80;
                        img.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*80+5}%;top:${Math.random()*60+20}%;opacity:0;animation-delay:-${Math.random()*10}s`;
                        container.appendChild(img);
                        setTimeout(() => img.style.opacity='1', 100);
                    }
                });
            });

            const upload = async (file, ai) => {
                if (!file) return;
                if (ai) document.getElementById('ai-processing').classList.remove('hidden');
                document.getElementById('status-msg').innerText = ai ? "é­”æ³•å•Ÿå‹•ä¸­..." : "å‚³é€ä¸­...";
                
                try {
                    // ä½¿ç”¨å¼·åˆ¶å£“ç¸®åŠŸèƒ½ï¼Œä¿è­‰å°æ–¼ 1MB
                    let b64 = await aggressiveResize(file); 
                    if (ai) b64 = await runAI(b64);
                    
                    await addDoc(collection(db, 'artifacts', weddingId, 'public', 'data', 'photos'), {
                        imageUrl: b64, timestamp: Date.now(), type: ai ? 'ai' : 'normal'
                    });
                    document.getElementById('status-msg').innerText = "ä¸Šå‚³æˆåŠŸï¼";
                } catch (e) {
                    showMessage("ä¸Šå‚³å¤±æ•—", e.message, "âŒ");
                } finally {
                    document.getElementById('ai-processing').classList.add('hidden');
                    setTimeout(() => document.getElementById('status-msg').innerText = "", 4000);
                }
            };

            document.getElementById('photo-input').onchange = (e) => upload(e.target.files[0], false);
            document.getElementById('ai-photo-input').onchange = (e) => upload(e.target.files[0], true);
        }

        // --- å¼·æ•ˆå£“ç¸®æŠ€è¡“ (è§£æ±º 1MB é™åˆ¶) ---
        async function aggressiveResize(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        let quality = 0.6;
                        let dimension = 800;
                        
                        const performCompress = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            if (w > dimension || h > dimension) {
                                if (w > h) { h *= dimension/w; w = dimension; } 
                                else { w *= dimension/h; h = dimension; }
                            }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            const b64 = canvas.toDataURL('image/jpeg', quality);
                            
                            // å¦‚æœé‚„æ˜¯å¤ªå¤§ (æ¥è¿‘ 1MB)ï¼Œå‰‡é™ä½ç•«è³ªèˆ‡å°ºå¯¸å†æ¬¡å˜—è©¦
                            if (b64.length > 950000 && quality > 0.1) {
                                quality -= 0.1;
                                dimension -= 100;
                                return performCompress();
                            }
                            return b64;
                        };
                        resolve(performCompress());
                    };
                };
            });
        }

        // --- ç®¡ç†å“¡ ---
        function showAdmin() {
            document.getElementById('admin-view').classList.remove('hidden');
            const input = document.getElementById('base-input'), btn = document.getElementById('save-base-btn'), preview = document.getElementById('base-preview');
            let pending = null;

            document.getElementById('test-api-btn').onclick = async () => {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Ping" }] }] })
                    });
                    if (res.ok) showMessage("é€£ç·šæˆåŠŸ", "Gemini 1.5 Flash é‹ä½œæ­£å¸¸ã€‚", "âœ…");
                    else showMessage("é€£ç·šå¤±æ•—", "è«‹æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢ºã€‚", "âŒ");
                } catch (e) { showMessage("éŒ¯èª¤", "ç¶²è·¯ç•°å¸¸ã€‚", "âŒ"); }
            };

            getDoc(doc(db, 'artifacts', weddingId, 'public', 'data', 'settings', 'couplePhoto')).then(s => {
                if (s.exists()) preview.innerHTML = `<img src="${s.data().imageUrl}" class="w-full h-full object-cover">`;
            });

            input.onchange = async (e) => {
                pending = await aggressiveResize(e.target.files[0]);
                preview.innerHTML = `<img src="${pending}" class="w-full h-full object-cover opacity-50">`;
                btn.classList.remove('hidden');
            };

            btn.onclick = async () => {
                try {
                    await setDoc(doc(db, 'artifacts', weddingId, 'public', 'data', 'settings', 'couplePhoto'), { imageUrl: pending });
                    showMessage("æˆåŠŸ", "æ–°äººåŸºåº•ç…§å·²æ›´æ–°ï¼", "âœ…");
                    btn.classList.add('hidden');
                    preview.querySelector('img').classList.remove('opacity-50');
                } catch (e) { showMessage("å„²å­˜å¤±æ•—", e.message, "âŒ"); }
            };

            onSnapshot(collection(db, 'artifacts', weddingId, 'public', 'data', 'photos'), (s) => {
                const gal = document.getElementById('admin-gallery'); gal.innerHTML = '';
                s.docs.forEach(d => {
                    const div = document.createElement('div'); div.className = 'relative group';
                    div.innerHTML = `<img src="${d.data().imageUrl}" class="w-full h-32 object-cover rounded-xl"><button class="absolute top-1 right-1 bg-red-500 text-white text-[10px] px-2 py-1 rounded-full opacity-0 group-hover:opacity-100" onclick="window.del('${d.id}')">åˆªé™¤</button>`;
                    gal.appendChild(div);
                });
            });
            window.del = (id) => { if(confirm('åˆªé™¤ï¼Ÿ')) deleteDoc(doc(db, 'artifacts', weddingId, 'public', 'data', 'photos', id)); };
        }

        // --- å¤§è¢å¹•æ’­æ”¾ ---
        function showDashboard() {
            document.getElementById('dashboard-view').classList.remove('hidden');
            const cont = document.getElementById('slideshow-container');
            let all = [], queue = [], playing = false;
            onSnapshot(collection(db, 'artifacts', weddingId, 'public', 'data', 'photos'), (s) => {
                all = s.docs.map(d => ({ imageUrl: d.data().imageUrl, type: d.data().type }));
                s.docChanges().forEach(c => { if (c.type === "added") queue.push(c.doc.data()); });
                if (!playing && all.length > 0) loop();
            });
            async function loop() {
                playing = true; let idx = 0;
                while (true) {
                    let next = queue.length > 0 ? queue.shift() : all[idx];
                    if (next) {
                        const frame = document.createElement('div'); frame.className = "absolute inset-0 flex items-center justify-center p-20 slide-up";
                        frame.innerHTML = `<div class="photo-card bg-white p-6 relative">
                            ${next.type==='ai'?'<div class="absolute -top-12 -right-12 bg-purple-600 text-white px-8 py-3 rounded-full font-bold shadow-2xl text-xl animate-bounce">AI MAGIC</div>':''}
                            <img src="${next.imageUrl}" class="max-w-full max-h-[70vh] object-contain">
                        </div>`;
                        if (cont.children.length > 0) {
                            const old = cont.children[0]; old.style.transition = "all 1s"; old.style.opacity = "0";
                            setTimeout(() => old.remove(), 1000);
                        }
                        cont.appendChild(frame); await new Promise(r => setTimeout(r, 6500));
                        idx = (idx + 1) % all.length;
                    } else await new Promise(r => setTimeout(r, 1000));
                }
            }
        }
    </script>
</body>
</html>