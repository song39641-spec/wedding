<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>囍．我們的婚禮規劃系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fffafb; overflow-x: hidden; }
        
        /* 修正 PNG 匯出文字切半問題 */
        .table-dot { transition: all 0.3s ease; cursor: pointer; }
        .table-dot:hover { transform: scale(1.1); filter: brightness(1.1); }
        
        /* 使用更穩定的文字容器佈局 */
        .table-label-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 4px;
            text-align: center;
            overflow: visible !important; /* 確保匯出時文字不被切斷 */
        }
        
        .table-label-text {
            font-size: 11px;
            line-height: 1.2;
            font-weight: 700;
            width: 100%;
            word-wrap: break-word;
            white-space: normal;
        }
        @media (min-width: 768px) {
            .table-label-text { font-size: 13px; }
        }

        .aisle { background: repeating-linear-gradient(45deg, #fff5f5, #fff5f5 10px, #fee2e2 10px, #fee2e2 20px); }
        .stage { background: linear-gradient(180deg, #e11d48 0%, #be123c 100%); box-shadow: 0 4px 15px rgba(225, 29, 72, 0.3); }
        @media (max-width: 640px) { .aisle { width: 3rem !important; } .stagger-offset { transform: translateY(20px); } }
        .stagger-offset { transform: translateY(40px); }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
        .countdown-card { background: linear-gradient(135deg, #fb7185 0%, #e11d48 100%); box-shadow: 0 4px 12px rgba(225, 29, 72, 0.2); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @media (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; margin-bottom: 1rem; border: 1px solid #fee2e2; border-radius: 1rem; padding: 0.5rem; background: white; }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem !important; }
            .responsive-table td::before { content: attr(data-label); font-weight: 700; color: #9f1239; font-size: 0.75rem; }
        }
        .btn-delete { color: #ef4444; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; font-size: 18px; }
        .btn-delete:hover { color: #b91c1c; background-color: #fee2e2; border-radius: 50%; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #e11d48; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen pb-10">

    <nav class="sticky top-0 z-40 glass-nav border-b border-rose-100 px-3 md:px-6 py-3 flex flex-col md:flex-row justify-between items-center gap-3">
        <div class="flex items-center justify-between w-full md:w-auto">
            <div class="flex items-center gap-2">
                <span class="text-2xl">囍</span>
                <h1 class="text-lg font-bold text-rose-700">婚禮規劃系統</h1>
            </div>
            <div id="sync-indicator" class="text-[10px] bg-rose-50 text-rose-400 px-2 py-1 rounded-full border border-rose-100 hidden flex items-center gap-1">
                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> 雲端同步中
            </div>
            <div class="md:hidden countdown-card text-white px-3 py-1 rounded-xl flex items-center gap-2">
                <div class="font-bold text-xs tabular-nums" id="countdown-timer-mobile">00天 00:00</div>
            </div>
        </div>
        
        <div class="flex gap-3 items-center w-full md:w-auto justify-center">
            <div id="nav-tabs-container" class="flex bg-rose-50/50 p-1 rounded-2xl text-[11px] md:text-xs overflow-x-auto no-scrollbar w-full md:max-w-none shadow-inner border border-rose-100/50"></div>
            <div class="hidden md:flex countdown-card text-white px-4 py-1.5 rounded-2xl items-center gap-3 shrink-0">
                <div class="font-bold text-sm tabular-nums" id="countdown-timer">00天 00:00:00</div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 mt-6">
        <!-- 1. 桌位配置圖 -->
        <div id="view-layout" class="tab-content space-y-4">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-xl font-bold text-rose-700">場地佈置圖</h2>
                <button id="btn-export-png" onclick="exportLayoutToPNG()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-2xl hover:bg-indigo-700 transition-all font-bold text-xs flex items-center gap-2 shadow-lg shadow-indigo-100">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    匯出 PNG 圖檔
                </button>
            </div>
            <div id="capture-area" class="bg-white p-4 md:p-8 rounded-[2rem] shadow-xl border border-rose-50 overflow-x-auto relative no-scrollbar">
                <div id="inner-capture" class="min-w-[800px] md:min-w-0 bg-white p-6">
                    <div class="stage w-full h-12 md:h-16 rounded-t-2xl flex items-center justify-center text-white font-bold text-sm md:text-xl mb-6 md:mb-8 tracking-widest">STAGE 舞台</div>
                    <div class="flex justify-center mb-12"><div id="main-table-container"></div></div>
                    <div class="flex justify-between gap-2 md:gap-4 mb-8 text-center">
                        <div class="flex-1"><div class="inline-block px-10 py-2.5 rounded-full bg-indigo-50 border border-indigo-100 text-indigo-700 font-bold text-sm shadow-sm">男方席</div></div>
                        <div class="w-16 md:w-24"></div>
                        <div class="flex-1"><div class="inline-block px-10 py-2.5 rounded-full bg-rose-50 border border-rose-100 text-rose-700 font-bold text-sm shadow-sm">女方席</div></div>
                    </div>
                    <div class="relative flex justify-between gap-2 md:gap-4 pb-8 md:pb-12">
                        <div class="grid grid-cols-2 gap-x-4 md:gap-x-8 gap-y-10 md:gap-y-12 flex-1"><div id="left-block" class="contents"></div></div>
                        <div class="aisle w-16 md:w-24 flex items-center justify-center rounded-2xl border-x-2 border-rose-100 min-h-[400px] md:min-h-[600px] text-rose-200 font-bold uppercase text-[10px] md:text-sm"><span class="rotate-90">走道 AISLE</span></div>
                        <div class="grid grid-cols-2 gap-x-4 md:gap-x-8 gap-y-10 md:gap-y-12 flex-1"><div id="right-block" class="contents"></div></div>
                    </div>
                    <div class="mt-12 md:mt-20 w-full border-t-2 md:border-t-4 border-dashed border-rose-100 pt-6 md:pt-8 flex justify-center text-rose-300 font-medium uppercase text-[10px] md:text-sm">Entrance 入口</div>
                </div>
            </div>
        </div>

        <!-- 各分頁：迎娶、流程、音樂、待辦、數據 -->
        <div id="view-pickup" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-[2rem] shadow-xl p-6 border border-rose-50">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-rose-700">迎娶儀式</h2><button onclick="addPickupSchedule()" class="bg-rose-500 text-white px-4 py-2 rounded-xl text-xs font-bold">+ 新增</button></div>
                    <div class="space-y-3" id="pickup-schedule-list"></div>
                </div>
                <div class="space-y-4"><div class="flex justify-between items-center"><h2 class="text-xl font-bold text-rose-700">禮車分配</h2><button onclick="addCar()" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-xs font-bold">+ 新增</button></div><div id="cars-container" class="grid gap-4"></div></div>
            </div>
        </div>

        <div id="view-schedule" class="tab-content hidden space-y-6">
            <div class="bg-white rounded-[2rem] shadow-xl p-6 border border-rose-50">
                <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-rose-700">婚宴流程表</h2><button onclick="addScheduleRow()" class="bg-rose-500 text-white px-4 py-2 rounded-xl text-xs font-bold">+ 新增</button></div>
                <div class="space-y-3" id="schedule-list"></div>
            </div>
        </div>

        <div id="view-music" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="music-lists-container"></div>
        </div>

        <div id="view-todo" class="tab-content hidden space-y-6">
            <div class="bg-white rounded-[2rem] shadow-xl p-6 border border-rose-50">
                <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-rose-700">任務清單</h2><button onclick="addTodoItem()" class="bg-rose-500 text-white px-4 py-2 rounded-xl text-xs font-bold">+ 新增任務</button></div>
                <div class="grid gap-3" id="todo-list"></div>
            </div>
        </div>

        <div id="view-data" class="tab-content hidden space-y-6">
            <div class="bg-white p-6 rounded-[2rem] shadow-xl border border-rose-50">
                <h3 class="text-lg font-bold text-gray-800 mb-2">數據管理</h3>
                <button onclick="exportToCSV()" class="bg-green-600 text-white px-6 py-3 rounded-2xl text-sm font-bold shadow-md">匯出 CSV 備份</button>
            </div>
            <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-rose-50">
                <div class="p-5 bg-rose-50/50 border-b border-rose-100"><h4 class="font-bold text-rose-900 text-sm">桌位名單明細</h4></div>
                <div class="overflow-x-auto"><table class="w-full text-left responsive-table"><thead class="bg-gray-50 text-[10px] text-gray-400 uppercase tracking-widest"><tr><th>桌號</th><th>桌名</th><th>人數</th><th>名單</th><th>操作</th></tr></thead><tbody id="data-table-body" class="divide-y divide-gray-100 text-sm"></tbody></table></div>
            </div>
        </div>
    </main>

    <!-- 編輯彈窗 -->
    <div id="modal" class="fixed inset-0 bg-black/70 z-50 flex items-end sm:items-center justify-center hidden backdrop-blur-md">
        <div class="bg-white w-full sm:max-w-2xl rounded-t-[2rem] sm:rounded-[2.5rem] p-6 md:p-10 shadow-2xl max-h-[95vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6"><h3 class="text-2xl font-bold text-rose-800" id="modal-title">管理座次</h3><button onclick="closeModal()" class="text-gray-300 text-3xl">&times;</button></div>
            <div class="space-y-6">
                <input type="text" id="edit-tableName" class="w-full p-4 bg-gray-50 border rounded-xl outline-none" placeholder="桌位名稱">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="guest-inputs-container"></div>
            </div>
            <div class="mt-8 flex flex-col-reverse sm:flex-row gap-3 pt-6 border-t"><button onclick="closeModal()" class="w-full py-4 text-gray-400 font-bold">取消</button><button onclick="saveTable()" class="w-full py-4 bg-rose-600 text-white rounded-2xl font-bold shadow-lg">儲存變更</button></div>
        </div>
    </div>

    <!-- 同步狀態標籤 -->
    <div id="sync-status" class="fixed bottom-4 right-4 bg-white/90 px-4 py-2 rounded-full shadow-lg border border-rose-100 text-rose-500 text-xs hidden flex items-center gap-2 z-50">
        <span class="loader w-3 h-3"></span> 雲端連動中
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- 硬編碼 Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBKnlRG1SF1Th2vYmedM64_EedVGTlt2s4",
            authDomain: "wedding-bf53c.firebaseapp.com",
            projectId: "wedding-bf53c",
            storageBucket: "wedding-bf53c.firebasestorage.app",
            messagingSenderId: "46733914591",
            appId: "1:46733914591:web:7a05452a53fd339c23546a",
            measurementId: "G-HJWE6MQZ8T"
        };

        const WEDDING_DATE = new Date("2026-03-01T00:00:00");
        const appId = 'wedding-bf53c-prod';
        let activeTab = 'layout';
        let syncTimer = null;
        let db, auth;

        let state = JSON.parse(localStorage.getItem('wedding_v17_offline_state')) || {
            seatingData: [],
            scheduleData: [{ id: 1, time: "12:00", event: "開席" }],
            pickupScheduleData: [{ id: 1, time: "08:00", event: "儀式準備" }],
            carData: [{ id: 1, info: "第一部車", passengers: ["司機"] }],
            musicData: { entrance: [], dining1: [], dining2: [] },
            todoData: [],
            tabOrder: [{ id: 'layout', name: '桌位圖' }, { id: 'pickup', name: '迎娶' }, { id: 'schedule', name: '流程' }, { id: 'music', name: '音樂' }, { id: 'todo', name: '待辦' }, { id: 'data', name: '數據' }]
        };

        const setupFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);

                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'configs', 'main');
                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        state = { ...state, ...snap.data() };
                        localStorage.setItem('wedding_v17_offline_state', JSON.stringify(state));
                        refreshUI();
                    } else {
                        checkInitSeating();
                        pushToCloud();
                    }
                    document.getElementById('sync-indicator').classList.remove('hidden');
                    document.getElementById('sync-indicator').classList.add('flex');
                });
            } catch (e) { console.error("Firebase 連線失敗", e); }
        };

        const pushToCloud = async () => {
            localStorage.setItem('wedding_v17_offline_state', JSON.stringify(state));
            if (!auth || !auth.currentUser) return;
            document.getElementById('sync-status').classList.remove('hidden');
            document.getElementById('sync-status').classList.add('flex');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'configs', 'main');
            await setDoc(docRef, state, { merge: true });
            setTimeout(() => document.getElementById('sync-status').classList.add('hidden'), 800);
        };

        window.debouncedPush = () => { clearTimeout(syncTimer); syncTimer = setTimeout(pushToCloud, 1000); };

        function checkInitSeating() {
            if (state.seatingData.length === 0) {
                state.seatingData.push({ id: 0, isMain: true, side: 'center', tableName: `主桌`, guests: Array(12).fill('') });
                for (let i = 1; i <= 28; i++) {
                    state.seatingData.push({ id: i, isMain: false, side: i <= 16 ? 'left' : 'right', tableName: `第 ${i} 桌`, guests: Array(10).fill(''), localIndex: (i <= 16 ? i : i - 16) - 1 });
                }
            }
        }

        window.switchTab = (id) => { activeTab = id; renderNav(); refreshUI(); };
        function renderNav() {
            document.getElementById('nav-tabs-container').innerHTML = state.tabOrder.map(tab => `<button onclick="switchTab('${tab.id}')" class="flex-1 px-4 py-2 rounded-xl font-bold transition-all whitespace-nowrap text-center ${activeTab === tab.id ? 'bg-white text-rose-700 shadow-sm' : 'text-rose-300'}">${tab.name}</button>`).join('');
        }

        function refreshUI() {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`view-${activeTab}`);
            if (target) target.classList.remove('hidden');
            if (activeTab === 'layout') renderLayout();
            if (activeTab === 'pickup') renderPickup();
            if (activeTab === 'schedule') renderSchedule();
            if (activeTab === 'music') renderMusic();
            if (activeTab === 'todo') renderTodo();
            if (activeTab === 'data') renderDataTable();
            updateCountdown();
        }

        function renderLayout() {
            const main = document.getElementById('main-table-container');
            const left = document.getElementById('left-block');
            const right = document.getElementById('right-block');
            main.innerHTML = left.innerHTML = right.innerHTML = '';
            state.seatingData.forEach(t => {
                const filled = t.guests.filter(g => g.trim()).length;
                let bg = 'bg-gray-50 text-gray-400 border';
                if (t.isMain) bg = 'bg-rose-700 text-white shadow-lg ring-2 ring-amber-300';
                else if (filled === t.guests.length) bg = 'bg-rose-600 text-white';
                else if (filled > 0) bg = 'bg-rose-400 text-white';
                const sClass = (!t.isMain && t.localIndex % 2 !== 0) ? 'stagger-offset' : '';
                
                // 改版後的圓圈文字佈局，解決 PNG 切斷問題
                const html = `
                    <div onclick="openEdit(${t.id})" class="table-dot flex flex-col items-center ${sClass}">
                        <div class="${t.isMain ? 'w-24 md:w-28 h-24 md:h-28' : 'w-16 md:w-20 h-16 md:h-20'} rounded-full flex items-center justify-center p-1 shadow-sm mb-2 ${bg}">
                            <div class="table-label-container">
                                <div class="table-label-text border-b border-white/20 pb-0.5 mb-0.5">${t.tableName}</div>
                                <div class="text-[9px] md:text-[10px] opacity-90">${filled}/${t.guests.length}</div>
                            </div>
                        </div>
                    </div>`;
                if (t.isMain) main.innerHTML = html; else if (t.side === 'left') left.innerHTML += html; else right.innerHTML += html;
            });
        }

        // 資料更新操作
        window.addPickupSchedule = () => { state.pickupScheduleData.push({ id: Date.now(), time: "08:00", event: "" }); refreshUI(); debouncedPush(); };
        window.deletePickup = (id) => { state.pickupScheduleData = state.pickupScheduleData.filter(x=>x.id !== id); refreshUI(); debouncedPush(); };
        window.updatePickup = (id,f,v) => { const i = state.pickupScheduleData.find(x=>x.id===id); if(i){i[f]=v; debouncedPush();} };
        window.addCar = () => { state.carData.push({ id: Date.now(), info: `領頭車`, passengers: ["司機"] }); refreshUI(); debouncedPush(); };
        window.deleteCar = (id) => { state.carData = state.carData.filter(x=>x.id !== id); refreshUI(); debouncedPush(); };
        window.updateCar = (id,v) => { const c = state.carData.find(x=>x.id===id); if(c){c.info=v; debouncedPush();} };
        window.addPax = (cid) => { const c = state.carData.find(x=>x.id===cid); if(c){c.passengers.push(""); refreshUI(); debouncedPush();} };
        window.updatePax = (cid,idx,v) => { const c = state.carData.find(x=>x.id===cid); if(c){c.passengers[idx]=v; debouncedPush();} };
        window.deletePax = (cid,idx) => { const c = state.carData.find(x=>x.id===cid); if(c){c.passengers.splice(idx,1); refreshUI(); debouncedPush();} };
        window.addScheduleRow = () => { state.scheduleData.push({ id: Date.now(), time: "12:00", event: "" }); refreshUI(); debouncedPush(); };
        window.deleteSchedule = (id) => { state.scheduleData = state.scheduleData.filter(x=>x.id !== id); refreshUI(); debouncedPush(); };
        window.updateSchedule = (id,f,v) => { const i = state.scheduleData.find(x=>x.id===id); if(i){i[f]=v; debouncedPush();} };
        window.addMusicItem = (k) => { state.musicData[k].push({ id: Date.now(), name: "", order: state.musicData[k].length+1 }); refreshUI(); debouncedPush(); };
        window.deleteMusic = (k,id) => { state.musicData[k] = state.musicData[k].filter(x=>x.id !== id); refreshUI(); debouncedPush(); };
        window.updateMusic = (k,id,f,v) => { const s = state.musicData[k].find(x=>x.id===id); if(s){s[f]=v; debouncedPush(); if(f==='order') refreshUI();} };
        window.addTodoItem = () => { state.todoData.push({ id: Date.now(), task: "", done: false }); refreshUI(); debouncedPush(); };
        window.deleteTodo = (id) => { state.todoData = state.todoData.filter(x=>x.id !== id); refreshUI(); debouncedPush(); };
        window.toggleTodo = (id) => { const i = state.todoData.find(x=>x.id===id); if(i){i.done=!i.done; refreshUI(); debouncedPush();} };
        window.updateTodo = (id,v) => { const i = state.todoData.find(x=>x.id===id); if(i){i.task=v; debouncedPush();} };

        let curId = null;
        window.openEdit = (id) => {
            curId = id; const t = state.seatingData.find(x => x.id === id);
            document.getElementById('modal-title').innerText = `${t.tableName}`;
            document.getElementById('edit-tableName').value = t.tableName;
            document.getElementById('guest-inputs-container').innerHTML = t.guests.map((name, i) => `<div class="relative"><span class="absolute left-4 top-4 text-[9px] text-gray-300 font-bold">${i+1}</span><input type="text" class="guest-input w-full p-4 pl-9 bg-gray-50 border rounded-xl text-xs font-medium" value="${name}"></div>`).join('');
            document.getElementById('modal').classList.remove('hidden');
        };
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');
        window.saveTable = () => {
            const idx = state.seatingData.findIndex(x => x.id === curId);
            state.seatingData[idx].tableName = document.getElementById('edit-tableName').value;
            state.seatingData[idx].guests = Array.from(document.querySelectorAll('.guest-input')).map(i => i.value.trim());
            closeModal(); refreshUI(); debouncedPush();
        };

        // --- 優化後的 PNG 匯出功能 ---
        window.exportLayoutToPNG = () => {
            const btn = document.getElementById('btn-export-png');
            const originalText = btn.innerHTML;
            btn.innerText = "生成中...";
            btn.disabled = true;

            // 給予短暫延遲確保 UI 渲染完全，並解決 html2canvas 座標問題
            setTimeout(() => {
                const el = document.getElementById('inner-capture');
                html2canvas(el, { 
                    scale: 3, // 進一步提高清晰度
                    backgroundColor: "#ffffff",
                    useCORS: true,
                    logging: false,
                    width: el.scrollWidth,
                    height: el.scrollHeight,
                    onclone: (clonedDoc) => {
                        // 在克隆出的 DOM 中移除溢出限制
                        const labels = clonedDoc.querySelectorAll('.table-label-container');
                        labels.forEach(l => l.style.overflow = 'visible');
                    }
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.download = '我們的婚禮場地佈置圖.png';
                    link.click();
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }, 500);
        };

        window.exportToCSV = () => {
            let csv = "\uFEFFID,桌名,名單\n" + state.seatingData.map(t => `"${t.id}","${t.tableName}","${t.guests.join(',')}"`).join("\n");
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); link.download = `wedding_backup.csv`; link.click();
        };

        function updateCountdown() {
            const diff = WEDDING_DATE - new Date();
            const tEl = document.getElementById('countdown-timer'), tElMob = document.getElementById('countdown-timer-mobile');
            if (diff <= 0) { tEl.innerText = tElMob.innerText = "新婚快樂！"; return; }
            const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
            tEl.innerText = `${d}天 ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            tElMob.innerText = `${d}天 ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        }
        setInterval(updateCountdown, 1000);

        window.onload = () => { setupFirebase(); renderNav(); refreshUI(); };

        function renderMusic() {
            const cats = ["entrance", "dining1", "dining2"]; const names = ["賓客入場", "一進用餐", "二進用餐"];
            document.getElementById('music-lists-container').innerHTML = cats.map((k, idx) => `<div class="bg-white rounded-3xl shadow-lg border border-rose-50 overflow-hidden"><div class="p-4 bg-rose-50 border-b flex justify-between items-center"><h3 class="font-bold text-rose-800 text-sm">${names[idx]}</h3><button onclick="addMusicItem('${k}')" class="text-[10px] bg-rose-500 text-white px-2 py-1 rounded-lg">加曲</button></div><div class="p-4 space-y-2">${state.musicData[k].sort((a,b)=>a.order-b.order).map(s => `<div class="bg-rose-50/50 p-2 rounded-xl flex items-center gap-2"><button onclick="deleteMusic('${k}',${s.id})" class="btn-delete text-xs">✕</button><input type="number" value="${s.order}" onchange="updateMusic('${k}',${s.id},'order',this.value)" class="w-8 text-center bg-white rounded text-[10px]"><input type="text" value="${s.name}" onchange="updateMusic('${k}',${s.id},'name',this.value)" class="flex-1 bg-transparent text-[10px] outline-none"></div>`).join('')}</div></div>`).join('');
        }
        function renderPickup() {
            document.getElementById('pickup-schedule-list').innerHTML = state.pickupScheduleData.map(i => `<div class="flex gap-2 bg-rose-50/40 p-3 rounded-2xl items-center"><button onclick="deletePickup(${i.id})" class="btn-delete">✕</button><input type="time" value="${i.time}" onchange="updatePickup(${i.id},'time',this.value)" class="bg-white rounded-lg p-2 text-rose-600 font-bold text-xs"><input type="text" value="${i.event}" onchange="updatePickup(${i.id},'event',this.value)" class="flex-1 bg-transparent border-none text-xs"></div>`).join('');
            document.getElementById('cars-container').innerHTML = state.carData.map(c => `<div class="bg-white border border-rose-50 p-5 rounded-[2rem] shadow-sm"><div class="flex items-center gap-2 mb-4"><button onclick="deleteCar(${c.id})" class="btn-delete text-sm">✕</button><input type="text" value="${c.info}" onchange="updateCar(${c.id},this.value)" class="font-bold text-rose-800 outline-none w-full"></div><div class="grid grid-cols-2 gap-2">${c.passengers.map((p,idx)=>`<div class="flex items-center gap-1 bg-gray-50 p-2 rounded-xl"><button onclick="deletePax(${c.id},${idx})" class="text-gray-300">×</button><input type="text" value="${p}" onchange="updatePax(${c.id},${idx},this.value)" class="bg-transparent text-[10px] w-full outline-none"></div>`).join('')}<button onclick="addPax(${c.id})" class="text-[10px] border border-dashed border-rose-200 text-rose-300 rounded-xl py-2">+ 加人</button></div></div>`).join('');
        }
        function renderSchedule() { document.getElementById('schedule-list').innerHTML = state.scheduleData.map(i => `<div class="flex gap-2 bg-rose-50/20 p-4 rounded-2xl items-center"><button onclick="deleteSchedule(${i.id})" class="btn-delete">✕</button><input type="time" value="${i.time}" onchange="updateSchedule(${i.id},'time',this.value)" class="bg-white rounded-lg p-2 text-rose-600 font-bold text-sm"><input type="text" value="${i.event}" onchange="updateSchedule(${i.id},'event',this.value)" class="flex-1 bg-transparent border-none text-sm font-medium"></div>`).join(''); }
        function renderTodo() { document.getElementById('todo-list').innerHTML = state.todoData.map(i => `<div class="flex items-center gap-2 bg-white p-4 rounded-2xl border shadow-sm"><button onclick="deleteTodo(${i.id})" class="btn-delete">✕</button><input type="checkbox" ${i.done?'checked':''} onchange="toggleTodo(${i.id})" class="accent-rose-500 h-5 w-5"><input type="text" value="${i.task}" onchange="updateTodo(${i.id},this.value)" class="flex-1 outline-none text-sm ${i.done?'line-through text-gray-300':''}"></div>`).join(''); }
        function renderDataTable() { document.getElementById('data-table-body').innerHTML = state.seatingData.map(t => `<tr class="hover:bg-rose-50/30 transition-colors"><td class="px-6 py-4" data-label="桌號">${t.isMain ? '★' : t.id}</td><td class="px-6 py-4 font-bold text-rose-800" data-label="桌名">${t.tableName}</td><td class="px-6 py-4" data-label="人數">${t.guests.filter(g=>g.trim()).length}/${t.guests.length}</td><td class="px-6 py-4 text-[10px] text-gray-400 max-w-[150px] truncate" data-label="名單">${t.guests.join(',')}</td><td class="px-6 py-4" data-label="操作"><button onclick="openEdit(${t.id})" class="text-rose-500 font-bold hover:underline">編輯</button></td></tr>`).join(''); }
    </script>
</body>
</html>