<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›ï¼æˆ‘å€‘çš„å©šç¦®è¦åŠƒç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fffafb; overflow-x: hidden; }
        
        /* æ‹–æ‹½äº¤æ›è¦–è¦ºæ•ˆæœ */
        .table-dot { transition: all 0.3s ease; cursor: grab; }
        .table-dot:active { cursor: grabbing; }
        .dragging { opacity: 0.4; transform: scale(1.1); }
        .drag-over { border: 2px dashed #e11d48 !important; background-color: #fff1f2 !important; }
        
        .table-label-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 4px; text-align: center; overflow: visible !important; pointer-events: none; }
        /* å¢åŠ å­—é«”å¤§å°ä»¥æ­é…æ”¾å¤§çš„åœ“å½¢æ¡Œ */
        .table-label-text { font-size: 12px; line-height: 1.2; font-weight: 700; width: 100%; word-wrap: break-word; white-space: normal; }
        @media (min-width: 768px) { .table-label-text { font-size: 15px; } }

        .aisle { background: repeating-linear-gradient(45deg, #fff5f5, #fff5f5 10px, #fee2e2 10px, #fee2e2 20px); }
        .stage { background: linear-gradient(180deg, #e11d48 0%, #be123c 100%); box-shadow: 0 4px 15px rgba(225, 29, 72, 0.3); }
        
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
        .countdown-card { background: linear-gradient(135deg, #fb7185 0%, #e11d48 100%); box-shadow: 0 4px 12px rgba(225, 29, 72, 0.2); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @media (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; margin-bottom: 1rem; border: 1px solid #fee2e2; border-radius: 1rem; padding: 0.5rem; background: white; }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem !important; }
            .responsive-table td::before { content: attr(data-label); font-weight: 700; color: #9f1239; font-size: 0.75rem; }
        }
        .btn-delete { color: #ef4444; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; min-width: 28px; height: 28px; font-size: 16px; border-radius: 50%; }
        .btn-delete:hover { background-color: #fee2e2; }

        .btn-order { color: #94a3b8; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; font-size: 14px; cursor: pointer; }
        .btn-order:hover { color: #e11d48; background-color: #fff1f2; border-radius: 4px; }

        .progress-bar { transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #e11d48; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .group-title-input { background: transparent; border: none; border-bottom: 2px solid transparent; width: 100%; font-weight: 700; color: #9f1239; font-size: 1.125rem; outline: none; padding: 2px 0; transition: all 0.2s; }
        .group-title-input:focus { border-bottom-color: #fda4af; }
    </style>
</head>
<body class="min-h-screen pb-10">

    <nav class="sticky top-0 z-40 glass-nav border-b border-rose-100 px-3 md:px-6 py-3 flex flex-col md:flex-row justify-between items-center gap-3">
        <div class="flex items-center justify-between w-full md:w-auto">
            <div class="flex items-center gap-2">
                <span class="text-2xl">å›</span>
                <h1 class="text-lg font-bold text-rose-700">å©šç¦®è¦åŠƒç³»çµ±</h1>
            </div>
            <div id="sync-indicator" class="text-[10px] bg-rose-50 text-rose-400 px-2 py-1 rounded-full border border-rose-100 hidden flex items-center gap-1">
                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> é›²ç«¯åŒæ­¥ä¸­
            </div>
            <div class="md:hidden countdown-card text-white px-3 py-1 rounded-xl flex items-center gap-2">
                <div class="font-bold text-xs tabular-nums" id="countdown-timer-mobile">00å¤© 00:00</div>
            </div>
        </div>
        <div class="flex gap-3 items-center w-full md:w-auto justify-center">
            <div id="nav-tabs-container" class="flex bg-rose-50/50 p-1 rounded-2xl text-[11px] md:text-xs overflow-x-auto no-scrollbar w-full md:max-w-none shadow-inner border border-rose-100/50"></div>
            <div class="hidden md:flex countdown-card text-white px-4 py-1.5 rounded-2xl items-center gap-3 shrink-0">
                <div class="font-bold text-sm tabular-nums" id="countdown-timer">00å¤© 00:00:00</div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 mt-6">
        <!-- 1. æ¡Œä½é…ç½®åœ– -->
        <div id="view-layout" class="tab-content space-y-4">
            <div class="flex flex-col sm:flex-row justify-between items-center px-2 gap-2">
                <h2 class="text-xl font-bold text-rose-700">å ´åœ°ä½ˆç½®åœ– <span class="text-[10px] font-normal text-gray-400 ml-2">(ç›´å‘é èµ°é“ 6 æ¡Œï¼Œé å‚™æ¡Œåœ¨å³å¤–å´)</span></h2>
                <button onclick="exportLayoutToPNG()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-2xl hover:bg-indigo-700 transition-all font-bold text-xs flex items-center gap-2 shadow-lg">åŒ¯å‡º PNG</button>
            </div>
            <div id="capture-area" class="bg-white p-4 md:p-8 rounded-[2rem] shadow-xl border border-rose-50 overflow-x-auto relative no-scrollbar">
                <div id="inner-capture" class="min-w-[1000px] md:min-w-0 bg-white p-8 md:p-12">
                    <div class="stage w-full h-12 md:h-16 rounded-t-2xl flex items-center justify-center text-white font-bold text-sm md:text-xl mb-10 md:mb-16 tracking-widest shadow-sm">STAGE èˆå°</div>
                    <div class="flex justify-center mb-12 md:mb-16"><div id="main-table-container"></div></div>
                    
                    <!-- å‡ç´šç‰ˆæ’ç‰ˆï¼šç”·å¥³æ–¹å¸­æ¨™é¡Œèˆ‡æ¡Œä½åˆä½µï¼Œä»¥æ¨™é¡Œç‚ºä¸­å¿ƒå°é½Š -->
                    <div class="relative flex justify-between pb-12 w-full max-w-[1200px] mx-auto items-stretch">
                        <!-- å·¦å´ï¼šç”·æ–¹å¸­å€åŸŸ -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="inline-block px-12 py-3 rounded-full bg-indigo-50 border border-indigo-100 text-indigo-700 font-bold text-sm md:text-base shadow-sm mb-12 md:mb-16">ç”·æ–¹å¸­</div>
                            <!-- å·¦å´ï¼šå¤–æ’(é ä¸Š)èˆ‡å…§æ’(ä¸‹ç§») (Flex) -->
                            <div class="flex gap-x-8 md:gap-x-12 justify-center">
                                <div class="flex flex-col gap-y-12 md:gap-y-16 items-center" id="left-outer"></div>
                                <div class="flex flex-col gap-y-12 md:gap-y-16 items-center mt-12 md:mt-24" id="left-inner"></div>
                            </div>
                        </div>
                        
                        <!-- ä¸­é–“èµ°é“ (è‡ªå‹•æ‹‰ä¼¸é«˜åº¦ä»¥é…åˆä½ˆå±€) -->
                        <div class="aisle w-20 md:w-32 flex items-center justify-center rounded-3xl border-x-2 border-rose-100 text-rose-200 font-bold uppercase text-xs md:text-base mx-6 md:mx-10 shadow-inner shrink-0">
                            <span class="rotate-90 whitespace-nowrap tracking-widest">èµ°é“ AISLE</span>
                        </div>
                        
                        <!-- å³å´ï¼šå¥³æ–¹å¸­å€åŸŸ -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="inline-block px-12 py-3 rounded-full bg-rose-50 border border-rose-100 text-rose-700 font-bold text-sm md:text-base shadow-sm mb-12 md:mb-16">å¥³æ–¹å¸­</div>
                            <!-- å³å´ï¼šå…§æ’èˆ‡å¤–æ’(ä¸‹ç§») (Flex) -->
                            <div class="flex gap-x-8 md:gap-x-12 justify-center">
                                <div class="flex flex-col gap-y-12 md:gap-y-16 items-center" id="right-inner"></div>
                                <div class="flex flex-col gap-y-12 md:gap-y-16 items-center mt-12 md:mt-24" id="right-outer"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="w-full border-t-2 md:border-t-4 border-dashed border-rose-100 pt-8 mt-8 flex justify-center text-rose-300 font-medium uppercase text-[10px] md:text-sm">Entrance å…¥å£</div>
                </div>
            </div>
        </div>

        <!-- 2. è¿å¨¶é é¢ -->
        <div id="view-pickup" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-[2rem] shadow-xl p-6 border border-rose-50">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-rose-700">è¿å¨¶å„€å¼</h2><button onclick="addPickupSchedule()" class="bg-rose-500 text-white px-4 py-2 rounded-xl text-xs font-bold">+ æ–°å¢ç’°ç¯€</button></div>
                    <div class="space-y-3" id="pickup-schedule-list"></div>
                </div>
                <div class="space-y-4">
                    <div class="flex justify-between items-center"><h2 class="text-xl font-bold text-rose-700">ç¦®è»Šåˆ†é…</h2><button onclick="addCar()" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-xs font-bold">+ æ–°å¢è»Šè¼›</button></div>
                    <div id="cars-container" class="grid gap-4"></div>
                </div>
            </div>
        </div>

        <!-- 3. å©šå®´æµç¨‹é é¢ -->
        <div id="view-schedule" class="tab-content hidden space-y-6">
            <div class="bg-white rounded-[2rem] shadow-xl p-6 border border-rose-50">
                <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-rose-700">å©šå®´æµç¨‹è¡¨</h2><button onclick="addScheduleRow()" class="bg-rose-500 text-white px-4 py-2 rounded-xl text-xs font-bold">+ æ–°å¢ç’°ç¯€</button></div>
                <div class="space-y-3" id="schedule-list"></div>
            </div>
        </div>

        <!-- 4. éŸ³æ¨‚é é¢ -->
        <div id="view-music" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="music-lists-container"></div>
        </div>

        <!-- 5. å¾…è¾¦äº‹é …é é¢ -->
        <div id="view-todo" class="tab-content hidden space-y-6">
            <div class="flex flex-col sm:flex-row justify-between items-center px-2 gap-4">
                <h2 class="text-xl font-bold text-rose-700 shrink-0">ä»»å‹™é€²åº¦è¿½è¹¤</h2>
                <div class="flex w-full max-w-md gap-2">
                    <input type="text" id="new-todo-group-input" placeholder="è¼¸å…¥æ–°çš„ä¸»ä»»å‹™åç¨±..." class="flex-1 p-3 bg-white border border-rose-100 rounded-xl text-sm outline-none focus:ring-2 focus:ring-rose-200">
                    <button onclick="addTodoGroup()" class="bg-rose-600 text-white px-6 py-2 rounded-xl text-xs font-bold whitespace-nowrap shadow-lg shadow-rose-100">å»ºç«‹</button>
                </div>
            </div>
            <div class="grid gap-6" id="todo-groups-container"></div>
        </div>

        <!-- 6. æ•¸æ“šç®¡ç† -->
        <div id="view-data" class="tab-content hidden space-y-6">
            <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-rose-50">
                <div class="p-5 bg-rose-50/50 border-b border-rose-100 flex justify-between items-center">
                    <h4 class="font-bold text-rose-900 text-sm">æ•¸æ“šç®¡ç†</h4>
                    <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-xl font-bold text-xs">åŒ¯å‡º CSV</button>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50 text-[10px] text-gray-400 uppercase tracking-widest"><tr><th class="px-6 py-3">æ¡Œè™Ÿ</th><th class="px-6 py-3">æ¡Œå</th><th class="px-6 py-3">äººæ•¸</th><th class="px-6 py-3">å…’ç«¥æ¤…</th><th class="px-6 py-3">æ“ä½œ</th></tr></thead><tbody id="data-table-body" class="divide-y divide-gray-100 text-sm"></tbody></table></div>
            </div>
        </div>
    </main>

    <!-- ç·¨è¼¯ Modal -->
    <div id="modal" class="fixed inset-0 bg-black/70 z-50 flex items-end sm:items-center justify-center hidden backdrop-blur-md">
        <div class="bg-white w-full sm:max-w-2xl rounded-t-[2rem] sm:rounded-[2.5rem] p-6 md:p-10 shadow-2xl max-h-[95vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6"><h3 class="text-2xl font-bold text-rose-800" id="modal-title">ç®¡ç†åº§æ¬¡</h3><button onclick="closeModal()" class="text-gray-300 text-3xl">&times;</button></div>
            <div class="space-y-6">
                <input type="text" id="edit-tableName" class="w-full p-4 bg-gray-50 border rounded-xl outline-none font-bold" placeholder="æ¡Œä½åç¨±">
                <div>
                    <label class="text-xs font-bold text-gray-400 mb-1 block">éœ€è¦å¹¾å¼µå…’ç«¥åº§æ¤…ï¼Ÿ</label>
                    <input type="number" id="edit-babySeats" class="w-full p-3 bg-gray-50 border rounded-xl outline-none font-bold text-amber-500" placeholder="0" min="0">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="guest-inputs-container"></div>
            </div>
            <div class="mt-8 flex flex-col-reverse sm:flex-row gap-3 pt-6 border-t"><button onclick="closeModal()" class="w-full py-4 text-gray-400 font-bold">å–æ¶ˆ</button><button onclick="saveTable()" class="w-full py-4 bg-rose-600 text-white rounded-2xl font-bold shadow-lg">å„²å­˜</button></div>
        </div>
    </div>

    <div id="sync-status" class="fixed bottom-4 right-4 bg-white/90 px-4 py-2 rounded-full shadow-lg border border-rose-100 text-rose-500 text-xs hidden flex items-center gap-2 z-50">
        <span class="loader w-3 h-3"></span> åŒæ­¥ä¸­...
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBKnlRG1SF1Th2vYmedM64_EedVGTlt2s4",
            authDomain: "wedding-bf53c.firebaseapp.com",
            projectId: "wedding-bf53c",
            storageBucket: "wedding-bf53c.firebasestorage.app",
            messagingSenderId: "46733914591",
            appId: "1:46733914591:web:7a05452a53fd339c23546a",
            measurementId: "G-HJWE6MQZ8T"
        };

        const WEDDING_DATE = new Date("2026-03-01T00:00:00");
        const appId = 'wedding-bf53c-prod';
        let activeTab = 'layout';
        let syncTimer = null;
        let db, auth;

        let state = JSON.parse(localStorage.getItem('wedding_v26_state')) || {
            seatingData: [],
            scheduleData: [{ id: 1, time: "12:00", event: "é–‹å¸­å„€å¼" }],
            pickupScheduleData: [{ id: 1, time: "08:00", event: "åŒ–å¦æº–å‚™" }],
            carData: [{ id: 1, info: "ç¬¬ä¸€éƒ¨è»Š", passengers: ["å¸æ©Ÿ"] }],
            musicData: { entrance: [], dining1: [], dining2: [] },
            todoGroups: [],
            tabOrder: [{ id: 'layout', name: 'æ¡Œä½åœ–' }, { id: 'pickup', name: 'è¿å¨¶' }, { id: 'schedule', name: 'æµç¨‹' }, { id: 'music', name: 'éŸ³æ¨‚' }, { id: 'todo', name: 'å¾…è¾¦' }, { id: 'data', name: 'æ•¸æ“š' }]
        };

        const setupFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);

                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'configs', 'main');
                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        let incoming = snap.data();
                        
                        // --- é å‚™æ¡Œè‡ªå‹•æ¸…ç†èˆ‡æ­¸ä½é‚è¼¯ ---
                        if (incoming.seatingData) {
                            let normals = [];
                            let reserves = [];
                            
                            incoming.seatingData.forEach(t => {
                                if (t.tableName.includes('é å‚™') || t.side === 'reserve') {
                                    reserves.push(t);
                                } else {
                                    normals.push(t);
                                }
                            });

                            if (reserves.length > 0) {
                                let mainReserve = reserves[0];
                                mainReserve.side = 'right'; 
                                if(mainReserve.tableName === 'ç¬¬ 25 æ¡Œ' || mainReserve.tableName.startsWith('é å‚™')) {
                                    mainReserve.tableName = 'é å‚™æ¡Œ';
                                }
                                normals.push(mainReserve);
                            }
                            
                            incoming.seatingData = normals;
                        }

                        if (incoming.todoData && incoming.todoData.length > 0 && (!incoming.todoGroups || incoming.todoGroups.length === 0)) {
                            incoming.todoGroups = [{
                                id: Date.now(),
                                title: "å¾èˆŠç‰ˆé·ç§»ä¹‹ä»»å‹™",
                                subtasks: incoming.todoData.map(t => ({
                                    id: t.id,
                                    text: t.task || t.text || "æœªå‘½åé …ç›®",
                                    completed: t.done || t.completed || false
                                }))
                            }];
                            delete incoming.todoData;
                        }

                        state = { ...state, ...incoming };
                        localStorage.setItem('wedding_v26_state', JSON.stringify(state));
                        refreshUI();
                    } else {
                        initSeating();
                        pushToCloud();
                    }
                    document.getElementById('sync-indicator').classList.remove('hidden');
                    document.getElementById('sync-indicator').classList.add('flex');
                });
            } catch (e) { console.error("Firebase é€£ç·šå¤±æ•—", e); }
        };

        const pushToCloud = async () => {
            localStorage.setItem('wedding_v26_state', JSON.stringify(state));
            if (!auth || !auth.currentUser) return;
            document.getElementById('sync-status').classList.remove('hidden');
            document.getElementById('sync-status').classList.add('flex');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'configs', 'main');
            await setDoc(docRef, state, { merge: true });
            setTimeout(() => document.getElementById('sync-status').classList.add('hidden'), 800);
        };

        window.debouncedPush = () => { clearTimeout(syncTimer); syncTimer = setTimeout(pushToCloud, 1000); };

        function initSeating() {
            if (state.seatingData.length === 0) {
                state.seatingData.push({ id: 0, isMain: true, side: 'center', tableName: `ä¸»æ¡Œ`, guests: Array(12).fill(''), babySeats: 0 });
                for (let i = 1; i <= 24; i++) {
                    state.seatingData.push({ id: i, isMain: false, side: i <= 12 ? 'left' : 'right', tableName: `ç¬¬ ${i} æ¡Œ`, guests: Array(10).fill(''), babySeats: 0 });
                }
                state.seatingData.push({ id: 25, isMain: false, side: 'right', tableName: `é å‚™æ¡Œ`, guests: Array(10).fill(''), babySeats: 0 });
            }
        }

        // --- æ‹–æ›³æ ¸å¿ƒ ---
        let dragSourceId = null;
        function handleDragStart(e) { dragSourceId = e.target.dataset.id; e.target.classList.add('dragging'); }
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); return false; }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function handleDrop(e) {
            e.preventDefault(); e.currentTarget.classList.remove('drag-over');
            const targetId = e.currentTarget.dataset.id;
            if (dragSourceId && dragSourceId !== targetId) {
                const sIdx = state.seatingData.findIndex(t => t.id == dragSourceId);
                const tIdx = state.seatingData.findIndex(t => t.id == targetId);
                const sName = state.seatingData[sIdx].tableName, sGuests = [...state.seatingData[sIdx].guests], sBaby = state.seatingData[sIdx].babySeats;
                state.seatingData[sIdx].tableName = state.seatingData[tIdx].tableName;
                state.seatingData[sIdx].guests = [...state.seatingData[tIdx].guests];
                state.seatingData[sIdx].babySeats = state.seatingData[tIdx].babySeats;
                state.seatingData[tIdx].tableName = sName;
                state.seatingData[tIdx].guests = sGuests;
                state.seatingData[tIdx].babySeats = sBaby;
                refreshUI(); debouncedPush();
            }
        }

        // --- æ’åºåŠŸèƒ½ ---
        window.reorderItem = (arrayName, index, dir) => {
            const arr = state[arrayName];
            const newIndex = dir === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= arr.length) return;
            [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]];
            refreshUI(); debouncedPush();
        };

        // --- å¾…è¾¦åŠŸèƒ½ ---
        window.addTodoGroup = () => {
            const input = document.getElementById('new-todo-group-input');
            const title = input.value.trim();
            if (!title) return;
            state.todoGroups.push({ id: Date.now(), title, subtasks: [] });
            input.value = ''; refreshUI(); debouncedPush();
        };
        window.updateTodoGroupTitle = (id, newTitle) => {
            const g = state.todoGroups.find(x => x.id === id);
            if (g) { g.title = newTitle; debouncedPush(); }
        };
        window.addSubtask = (gid) => {
            const input = document.getElementById(`new-subtask-input-${gid}`);
            const text = input.value.trim();
            if (!text) return;
            const g = state.todoGroups.find(x=>x.id===gid);
            g.subtasks.push({ id: Date.now(), text, completed: false });
            input.value = ''; refreshUI(); debouncedPush();
        };
        window.toggleSubtask = (gid, sid) => {
            const g = state.todoGroups.find(x=>x.id===gid);
            const s = g.subtasks.find(x=>x.id===sid);
            s.completed = !s.completed; refreshUI(); debouncedPush();
        };
        window.deleteTodoGroup = (id) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ")) { state.todoGroups = state.todoGroups.filter(x=>x.id!==id); refreshUI(); debouncedPush(); } };
        window.deleteSubtask = (gid, sid) => {
            const g = state.todoGroups.find(x=>x.id===gid);
            g.subtasks = g.subtasks.filter(x=>x.id!==sid); refreshUI(); debouncedPush();
        };

        // --- UI æ§åˆ¶ ---
        window.switchTab = (id) => { activeTab = id; renderNav(); refreshUI(); };
        function renderNav() {
            document.getElementById('nav-tabs-container').innerHTML = state.tabOrder.map(tab => `<button onclick="switchTab('${tab.id}')" class="flex-1 px-4 py-2 rounded-xl font-bold transition-all whitespace-nowrap text-center ${activeTab === tab.id ? 'bg-white text-rose-700 shadow-sm' : 'text-rose-300'}">${tab.name}</button>`).join('');
        }
        function refreshUI() {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`view-${activeTab}`);
            if (target) target.classList.remove('hidden');
            if (activeTab === 'layout') renderLayout();
            if (activeTab === 'pickup') renderPickup();
            if (activeTab === 'schedule') renderSchedule();
            if (activeTab === 'music') renderMusic();
            if (activeTab === 'todo') renderTodo();
            if (activeTab === 'data') renderDataTable();
            updateCountdown();
        }

        function renderLayout() {
            const main = document.getElementById('main-table-container');
            const leftInner = document.getElementById('left-inner');
            const leftOuter = document.getElementById('left-outer');
            const rightInner = document.getElementById('right-inner');
            const rightOuter = document.getElementById('right-outer');
            
            if(main) main.innerHTML = '';
            if(leftInner) leftInner.innerHTML = '';
            if(leftOuter) leftOuter.innerHTML = '';
            if(rightInner) rightInner.innerHTML = '';
            if(rightOuter) rightOuter.innerHTML = '';

            const createDot = (t) => {
                const filled = t.guests.filter(g => g.trim()).length;
                let bg = 'bg-gray-50 text-gray-400 border';
                if (t.isMain) bg = 'bg-rose-700 text-white shadow-lg ring-4 ring-amber-300/50';
                else if (filled === t.guests.length) bg = 'bg-rose-600 text-white shadow-md shadow-rose-200';
                else if (filled > 0) bg = 'bg-rose-400 text-white shadow-sm';
                
                const dot = document.createElement('div');
                dot.className = `table-dot flex flex-col items-center relative`;
                dot.draggable = true; dot.dataset.id = t.id;
                dot.addEventListener('dragstart', handleDragStart);
                dot.addEventListener('dragover', handleDragOver);
                dot.addEventListener('dragleave', handleDragLeave);
                dot.addEventListener('drop', handleDrop);
                dot.onclick = () => openEdit(t.id);

                const babyBadge = (t.babySeats && t.babySeats > 0) ? `<div class="absolute -top-2 -right-2 bg-orange-500 text-blue-900 text-sm md:text-xs rounded-full w-5 h-5 md:w-6 md:h-6 flex items-center justify-center font-bold shadow-md z-10 border-2 border-white" title="å…’ç«¥åº§æ¤…éœ€æ±‚">ğŸ‘¶${t.babySeats}</div>` : '';
                
                // æ”¾å¤§çš„åœ“åœˆå°ºå¯¸
                dot.innerHTML = `${babyBadge}<div class="${t.isMain ? 'w-32 md:w-40 h-32 md:h-40' : 'w-24 md:w-28 h-24 md:h-28'} rounded-full flex flex-col items-center justify-center p-2 shadow-md mb-3 transition-transform duration-300 ${bg}"><div class="table-label-container"><div class="table-label-text border-b border-white/30 pb-1 mb-1">${t.tableName}</div><div class="text-[10px] md:text-[13px] opacity-90 font-medium tracking-wide">${filled}/${t.guests.length}</div></div></div>`;
                return dot;
            };

            const leftTables = state.seatingData.filter(t => !t.isMain && t.side === 'left');
            const rightTables = state.seatingData.filter(t => !t.isMain && (t.side === 'right' || t.side === 'reserve'));
            const mainTable = state.seatingData.find(t => t.isMain);

            if (mainTable && main) main.appendChild(createDot(mainTable));

            if (leftInner && leftOuter) {
                leftTables.forEach((t, i) => {
                    if (i < 6) leftInner.appendChild(createDot(t));
                    else leftOuter.appendChild(createDot(t));
                });
            }

            if (rightInner && rightOuter) {
                // Ensure reserve is at the end
                rightTables.sort((a, b) => {
                    const aRes = a.tableName.includes('é å‚™') || a.side === 'reserve';
                    const bRes = b.tableName.includes('é å‚™') || b.side === 'reserve';
                    if (aRes && !bRes) return 1;
                    if (!aRes && bRes) return -1;
                    return 0;
                });
                rightTables.forEach((t, i) => {
                    if (i < 6) rightInner.appendChild(createDot(t));
                    else rightOuter.appendChild(createDot(t));
                });
            }
        }

        function renderPickup() {
            document.getElementById('pickup-schedule-list').innerHTML = state.pickupScheduleData.map((i, idx) => `
                <div class="flex gap-2 bg-rose-50/40 p-3 rounded-2xl items-center">
                    <div class="flex flex-col"><button onclick="reorderItem('pickupScheduleData', ${idx}, 'up')" class="btn-order">â–²</button><button onclick="reorderItem('pickupScheduleData', ${idx}, 'down')" class="btn-order">â–¼</button></div>
                    <button onclick="deletePickup(${i.id})" class="btn-delete px-1">âœ•</button>
                    <input type="time" value="${i.time}" onchange="updatePickup(${i.id},'time',this.value)" class="bg-white rounded-lg p-2 text-rose-600 font-bold text-xs">
                    <input type="text" value="${i.event}" onchange="updatePickup(${i.id},'event',this.value)" class="flex-1 bg-transparent border-none text-xs outline-none">
                </div>`).join('');
            document.getElementById('cars-container').innerHTML = state.carData.map((c, idx) => `
                <div class="bg-white border border-rose-50 p-5 rounded-[2rem] shadow-sm">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="flex flex-col"><button onclick="reorderItem('carData', ${idx}, 'up')" class="btn-order text-[10px]">â–²</button><button onclick="reorderItem('carData', ${idx}, 'down')" class="btn-order text-[10px]">â–¼</button></div>
                        <button onclick="deleteCar(${c.id})" class="btn-delete">âœ•</button>
                        <input type="text" value="${c.info}" onchange="updateCar(${c.id},this.value)" class="font-bold text-rose-800 outline-none w-full">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        ${c.passengers.map((p, pIdx) => `<div class="flex items-center gap-1 bg-gray-50 p-2 rounded-xl"><button onclick="deletePax(${c.id},${pIdx})" class="text-gray-300">Ã—</button><input type="text" value="${p}" onchange="updatePax(${c.id},${pIdx},this.value)" class="bg-transparent text-[10px] w-full outline-none"></div>`).join('')}
                        <button onclick="addPax(${c.id})" class="text-[10px] border border-dashed border-rose-200 text-rose-300 rounded-xl py-2">+ åŠ äºº</button>
                    </div>
                </div>`).join('');
        }

        function renderSchedule() {
            document.getElementById('schedule-list').innerHTML = state.scheduleData.map((i, idx) => `
                <div class="flex gap-2 bg-rose-50/20 p-4 rounded-2xl items-center">
                    <div class="flex flex-col"><button onclick="reorderItem('scheduleData', ${idx}, 'up')" class="btn-order">â–²</button><button onclick="reorderItem('scheduleData', ${idx}, 'down')" class="btn-order">â–¼</button></div>
                    <button onclick="deleteSchedule(${i.id})" class="btn-delete px-1">âœ•</button>
                    <input type="time" value="${i.time}" onchange="updateSchedule(${i.id},'time',this.value)" class="bg-white rounded-lg p-2 text-rose-600 font-bold text-sm">
                    <input type="text" value="${i.event}" onchange="updateSchedule(${i.id},'event',this.value)" class="flex-1 bg-transparent border-none text-sm font-medium outline-none">
                </div>`).join('');
        }

        function renderTodo() {
            document.getElementById('todo-groups-container').innerHTML = state.todoGroups.map((g, idx) => {
                const total = g.subtasks.length;
                const done = g.subtasks.filter(x => x.completed).length;
                const perc = total === 0 ? 0 : Math.round((done / total) * 100);
                return `
                <div class="bg-white rounded-[2rem] shadow-lg border border-rose-50 overflow-hidden">
                    <div class="p-6 pb-2">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-2 flex-1">
                                <div class="flex flex-col"><button onclick="reorderItem('todoGroups', ${idx}, 'up')" class="btn-order text-[10px]">â–²</button><button onclick="reorderItem('todoGroups', ${idx}, 'down')" class="btn-order text-[10px]">â–¼</button></div>
                                <div class="flex-1"><input type="text" value="${g.title}" onchange="updateTodoGroupTitle(${g.id}, this.value)" class="group-title-input"><p class="text-[10px] text-gray-400">é€²åº¦ï¼š${perc}%</p></div>
                            </div>
                            <button onclick="deleteTodoGroup(${g.id})" class="text-gray-300 text-xs hover:text-red-500 ml-2">âœ• åˆªé™¤</button>
                        </div>
                        <div class="w-full h-2 bg-rose-50 rounded-full overflow-hidden mb-6"><div class="progress-bar h-full bg-rose-500" style="width: ${perc}%"></div></div>
                    </div>
                    <div class="bg-gray-50/30 p-5 pt-0 space-y-2">
                        ${g.subtasks.map(s => `<div class="flex items-center gap-3 bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><input type="checkbox" ${s.completed ? 'checked' : ''} onchange="toggleSubtask(${g.id}, ${s.id})" class="accent-rose-500 h-5 w-5"><span class="flex-1 text-sm ${s.completed ? 'line-through text-gray-300' : 'text-gray-700 font-medium'}">${s.text}</span><button onclick="deleteSubtask(${g.id}, ${s.id})" class="text-gray-300">âœ•</button></div>`).join('')}
                        <div class="flex gap-2 pt-2">
                            <input type="text" id="new-subtask-input-${g.id}" placeholder="æ–°å¢å­é …ç›®..." class="flex-1 p-2 bg-white border border-dashed rounded-xl text-xs outline-none">
                            <button onclick="addSubtask(${g.id})" class="bg-rose-50 text-rose-600 px-4 py-2 rounded-xl text-[10px] font-bold">+ åŠ å…¥</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // å…¶é¤˜å·¥å…·
        function renderMusic() {
            const cats = ["entrance", "dining1", "dining2"]; const names = ["è³“å®¢å…¥å ´", "ä¸€é€²ç”¨é¤", "äºŒé€²ç”¨é¤"];
            document.getElementById('music-lists-container').innerHTML = cats.map((k, idx) => `<div class="bg-white rounded-3xl shadow-lg border border-rose-50 overflow-hidden"><div class="p-4 bg-rose-50 border-b flex justify-between items-center"><h3 class="font-bold text-rose-800 text-sm">${names[idx]}</h3><button onclick="addMusicItem('${k}')" class="text-[10px] bg-rose-500 text-white px-2 py-1 rounded-lg">åŠ æ›²</button></div><div class="p-4 space-y-2">${state.musicData[k].map((s, sIdx) => `<div class="bg-rose-50/50 p-2 rounded-xl flex items-center gap-2"><div class="flex flex-col"><button onclick="moveMusic('${k}',${sIdx},'up')" class="btn-order text-[10px]">â–²</button><button onclick="moveMusic('${k}',${sIdx},'down')" class="btn-order text-[10px]">â–¼</button></div><button onclick="deleteMusic('${k}',${s.id})" class="btn-delete text-xs">âœ•</button><input type="text" value="${s.name}" onchange="updateMusic('${k}',${s.id},'name',this.value)" class="flex-1 bg-transparent text-[10px] outline-none"></div>`).join('')}</div></div>`).join('');
        }
        window.moveMusic = (k, idx, dir) => { const arr = state.musicData[k]; const nIdx = dir === 'up' ? idx - 1 : idx + 1; if(nIdx < 0 || nIdx >= arr.length) return; [arr[idx], arr[nIdx]] = [arr[nIdx], arr[idx]]; refreshUI(); debouncedPush(); };
        function renderDataTable() { document.getElementById('data-table-body').innerHTML = state.seatingData.map(t => `<tr class="hover:bg-rose-50/30 transition-colors"><td class="px-6 py-4">${t.isMain ? 'â˜…' : t.id}</td><td class="px-6 py-4 font-bold text-rose-800">${t.tableName}</td><td class="px-6 py-4">${t.guests.filter(g=>g.trim()).length}/${t.guests.length}</td><td class="px-6 py-4 text-amber-500 font-bold">${t.babySeats || 0}</td><td class="px-6 py-4"><button onclick="openEdit(${t.id})" class="text-rose-500 font-bold hover:underline">ç·¨è¼¯</button></td></tr>`).join(''); }
        let curId = null;
        window.openEdit = (id) => { 
            curId = id; const t = state.seatingData.find(x => x.id === id); 
            document.getElementById('modal-title').innerText = `${t.tableName}`; 
            document.getElementById('edit-tableName').value = t.tableName; 
            document.getElementById('edit-babySeats').value = t.babySeats || 0;
            document.getElementById('guest-inputs-container').innerHTML = t.guests.map((name, i) => `<div class="relative"><span class="absolute left-4 top-4 text-[9px] text-gray-300 font-bold">${i+1}</span><input type="text" class="guest-input w-full p-4 pl-9 bg-gray-50 border rounded-xl text-xs font-medium" value="${name}"></div>`).join(''); 
            document.getElementById('modal').classList.remove('hidden'); 
        };
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');
        window.saveTable = () => { 
            const idx = state.seatingData.findIndex(x => x.id === curId); 
            state.seatingData[idx].tableName = document.getElementById('edit-tableName').value; 
            state.seatingData[idx].babySeats = parseInt(document.getElementById('edit-babySeats').value) || 0;
            state.seatingData[idx].guests = Array.from(document.querySelectorAll('.guest-input')).map(i => i.value.trim()); 
            closeModal(); refreshUI(); debouncedPush(); 
        };

        window.exportLayoutToPNG = () => { setTimeout(() => { html2canvas(document.getElementById('inner-capture'), { scale: 3, backgroundColor: "#ffffff", width: document.getElementById('inner-capture').scrollWidth }).then(canvas => { const link = document.createElement('a'); link.href = canvas.toDataURL('image/png', 1.0); link.download = 'å ´åœ°ä½ˆç½®åœ–.png'; link.click(); }); }, 500); };
        window.exportToCSV = () => { let csv = "\uFEFFID,æ¡Œå,åå–®\n" + state.seatingData.map(t => `"${t.id}","${t.tableName}","${t.guests.join(',')}"`).join("\n"); const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); link.download = `wedding_backup.csv`; link.click(); };
        function updateCountdown() { const diff = WEDDING_DATE - new Date(); const tEl = document.getElementById('countdown-timer'), tElMob = document.getElementById('countdown-timer-mobile'); if (diff <= 0) { tEl.innerText = tElMob.innerText = "æ–°å©šå¿«æ¨‚ï¼"; return; } const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000); tEl.innerText = `${d}å¤© ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; tElMob.innerText = `${d}å¤© ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; }
        setInterval(updateCountdown, 1000);

        // åˆå§‹åŒ–èˆ‡å•Ÿå‹•åŒæ­¥
        window.onload = () => { setupFirebase(); renderNav(); refreshUI(); };

        window.addPickupSchedule = () => { state.pickupScheduleData.push({ id: Date.now(), time: "08:00", event: "" }); refreshUI(); debouncedPush(); };
        window.deletePickup = (id) => { state.pickupScheduleData = state.pickupScheduleData.filter(x=>x.id!==id); refreshUI(); debouncedPush(); };
        window.updatePickup = (id,f,v) => { const i = state.pickupScheduleData.find(x=>x.id===id); if(i){i[f]=v; debouncedPush();} };
        window.addCar = () => { state.carData.push({ id: Date.now(), info: `é ˜é ­è»Š`, passengers: ["å¸æ©Ÿ"] }); refreshUI(); debouncedPush(); };
        window.deleteCar = (id) => { state.carData = state.carData.filter(x=>x.id!==id); refreshUI(); debouncedPush(); };
        window.updateCar = (id,v) => { const c = state.carData.find(x=>x.id===id); if(c){c.info=v; debouncedPush();} };
        window.addPax = (cid) => { const c = state.carData.find(x=>x.id===cid); if(c){c.passengers.push(""); refreshUI(); debouncedPush();} };
        window.updatePax = (cid,idx,v) => { const c = state.carData.find(x=>x.id===cid); if(c){c.passengers[idx]=v; debouncedPush();} };
        window.deletePax = (cid,idx) => { const c = state.carData.find(x=>x.id===cid); if(c){c.passengers.splice(idx,1); refreshUI(); debouncedPush();} };
        window.addScheduleRow = () => { state.scheduleData.push({ id: Date.now(), time: "12:00", event: "" }); refreshUI(); debouncedPush(); };
        window.deleteSchedule = (id) => { state.scheduleData = state.scheduleData.filter(x=>x.id!==id); refreshUI(); debouncedPush(); };
        window.updateSchedule = (id,f,v) => { const i = state.scheduleData.find(x=>x.id===id); if(i){i[f]=v; debouncedPush();} };
    </script>
</body>
</html>