<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ—¥æœ¬èœœæœˆè¡Œç¨‹ç®¡å®¶ (AI æ——è‰¦ç‰ˆ)</title>
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- React & Firebase -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.330.0?bundle",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
  </script>

  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    body { background-color: #fdf2f8; user-select: none; -webkit-tap-highlight-color: transparent; }
    input, textarea { user-select: text; }
    
    /* Loader */
    #initial-loader {
      position: fixed; inset: 0; background: #fff0f5; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s;
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #fbcfe8;
      border-top-color: #db2777; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="initial-loader">
    <div class="spinner"></div>
    <p class="mt-4 text-pink-600 font-bold animate-pulse">æ­£åœ¨å•Ÿå‹•è¡Œç¨‹ç®¡å®¶...</p>
  </div>

  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useCallback, memo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Calendar, MapPin, Utensils, CloudSun, ClipboardList, Ticket, 
      Plus, Trash2, Navigation, Heart, Edit2, CheckCircle, 
      ExternalLink, Loader2, RefreshCw, Image as ImageIcon, X,
      Languages, Sparkles, Cloud, ThermometerSun, Save, Calculator, Percent, AlertCircle, WifiOff, Users, ChevronDown, ChevronRight, RotateCcw, AlertTriangle, FileQuestion, LocateFixed, Camera, PenTool
    } from 'lucide-react';

    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from 'firebase/auth';
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from 'firebase/firestore';

    // AI API Key (De-identified)
    // å°‡ Key æ‹†è§£æˆå¤šå€‹éƒ¨åˆ†ï¼Œé¿å…ç›´æ¥è¢«çˆ¬èŸ²æ­£å‰‡è¡¨é”å¼æƒæåˆ°
    const _k_part1 = "AIzaSy";
    const _k_part2 = "BB0CxGCZWpE";
    const _k_part3 = "2d_GrAwiWR0";
    const _k_part4 = "IhmSmmN8_ZQ";
    const apiKey = `${_k_part1}${_k_part2}${_k_part3}${_k_part4}`;
    
    // Firebase Config (trevel-b526e)
    const firebaseConfig = {
      apiKey: "AIzaSyDGdudzKCHGhLJ0DLL7J5TnUIkEiqIlqjc",
      authDomain: "trevel-b526e.firebaseapp.com",
      projectId: "trevel-b526e",
      storageBucket: "trevel-b526e.firebasestorage.app",
      messagingSenderId: "174104732243",
      appId: "1:174104732243:web:5f38916efa6799e9c6dca6",
      measurementId: "G-29LLWF96VZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-honeymoon-app';

    const EXCHANGE_RATE = 0.21; 

    // --- AI Helper ---
    const fetchGemini = async (prompt, systemPrompt = "", setStatus) => {
      // å·²å°‡æ¨¡å‹ä¿®æ­£ç‚ºæ”¯æ´ generateContent çš„ç©©å®šç‰ˆæœ¬ gemini-1.5-flash
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
      
      if(setStatus) setStatus("æ­£åœ¨é€£ç·š AI æ¨¡å‹...");
      
      let delay = 1000;
      for (let i = 0; i < 3; i++) {
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
              generationConfig: { responseMimeType: "application/json" }
            })
          });
          
          if (!response.ok) {
              const errData = await response.json();
              throw new Error(`AI API Error: ${errData.error?.message || response.statusText}`);
          }

          if(setStatus) setStatus("AI æ­£åœ¨æ€è€ƒä¸¦æ’°å¯« JSON...");
          
          const data = await response.json();
          let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
          
          if (!text) throw new Error("AI å›å‚³å…§å®¹ç‚ºç©º");

          if(setStatus) setStatus("æ­£åœ¨è§£æè³‡æ–™...");
          console.log("Raw AI Response:", text); 

          // Robust Parsing
          const arrayMatch = text.match(/\[[\s\S]*\]/);
          if (arrayMatch) return JSON.parse(arrayMatch[0]);
          
          const objectMatch = text.match(/\{[\s\S]*\}/);
          if (objectMatch) return JSON.parse(objectMatch[0]);

          text = text.replace(/^```json\s*/, "").replace(/^```\s*/, "").replace(/```$/, "").trim();
          return JSON.parse(text);

        } catch (error) {
          console.warn(`Attempt ${i+1} failed:`, error);
          if (i === 2) throw error;
          if(setStatus) setStatus(`é€£ç·šä¸ç©©ï¼Œé‡è©¦ä¸­ (${i+1}/3)...`);
          await new Promise(r => setTimeout(r, delay));
          delay *= 1.5;
        }
      }
    };

    // --- COMPONENTS ---

    const WeatherCard = memo(({ info, onDelete }) => (
      <div className="bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl p-5 text-white shadow-md relative overflow-hidden mb-4 animate-in slide-in-from-top-2">
        <button onClick={() => onDelete(info.id)} className="absolute top-2 right-2 text-white/80 hover:text-white bg-white/20 rounded-full p-1"><X className="w-4 h-4"/></button>
        <div className="flex justify-between items-start mb-3">
            <div>
                <h3 className="text-xl font-bold flex items-center gap-2">{info.location}</h3>
                <span className="text-sm opacity-90">{info.temp}</span>
            </div>
            <CloudSun className="w-10 h-10 opacity-80" />
        </div>
        
        <div className="space-y-2">
            <div className="bg-white/20 p-2 rounded-lg">
                <span className="text-xs font-bold block opacity-70 mb-1">ğŸŒ¤ æ°£å€™</span>
                <p className="text-sm leading-tight">{info.weather}</p>
            </div>
            <div className="bg-white/20 p-2 rounded-lg">
                <span className="text-xs font-bold block opacity-70 mb-1">ğŸ‘• å»ºè­°ç©¿æ­</span>
                <p className="text-sm leading-tight">{info.clothing}</p>
            </div>
            <div className="bg-white/20 p-2 rounded-lg">
                <span className="text-xs font-bold block opacity-70 mb-1">âš ï¸ æ³¨æ„äº‹é …</span>
                <p className="text-sm leading-tight">{info.notes}</p>
            </div>
        </div>
      </div>
    ));

    const DaySection = memo(({ day, dIdx, currentTripId, updateEvent }) => {
        const [isExpanded, setIsExpanded] = useState(true);

        return (
            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-4">
                <div 
                    className="bg-pink-50/50 p-3 flex justify-between items-center cursor-pointer select-none"
                    onClick={() => setIsExpanded(!isExpanded)}
                >
                    <div className="flex items-center gap-2">
                        {isExpanded ? <ChevronDown className="w-4 h-4 text-pink-400" /> : <ChevronRight className="w-4 h-4 text-pink-400" />}
                        <h3 className="font-bold text-slate-800 flex flex-col sm:flex-row sm:gap-2 text-sm sm:text-base">
                            <span className="text-pink-600">Day {day.day}</span>
                            <span className="font-normal text-slate-500">{day.date} - {day.title}</span>
                        </h3>
                    </div>
                </div>
                
                {isExpanded && (
                    <div className="p-4 relative">
                        <div className="absolute left-[27px] top-4 bottom-4 w-0.5 bg-slate-100"></div>
                        {(day.events || []).map((event, eIdx) => (
                            <div key={eIdx} className="flex gap-4 relative mb-6 last:mb-0 group">
                                <div className="w-12 flex-shrink-0 flex flex-col items-end pt-1 z-10 bg-white">
                                    <input 
                                        type="text" 
                                        value={event.time || ''} 
                                        onChange={(e) => updateEvent(currentTripId, dIdx, eIdx, 'time', e.target.value)}
                                        className="text-xs font-bold text-slate-400 w-full text-right focus:text-pink-500 focus:outline-none bg-transparent"
                                    />
                                </div>
                                <div className="absolute left-[11px] top-2 w-2.5 h-2.5 rounded-full bg-pink-300 border-2 border-white shadow-sm z-20"></div>
                                <div className="flex-grow bg-slate-50/50 rounded-xl p-3 border border-slate-100 hover:border-pink-200 hover:shadow-sm transition-all group-hover:bg-white">
                                    <div className="flex items-start gap-2 mb-1">
                                        <input 
                                            type="text" 
                                            value={event.activity || ''} 
                                            onChange={(e) => updateEvent(currentTripId, dIdx, eIdx, 'activity', e.target.value)}
                                            className="w-full font-bold text-slate-700 text-sm focus:outline-none bg-transparent border-b border-transparent focus:border-pink-200"
                                        />
                                    </div>
                                    <div className="flex items-center gap-1 text-xs text-blue-500 mb-2">
                                        <MapPin className="w-3 h-3 flex-shrink-0" />
                                        <input 
                                            type="text"
                                            value={event.location || ''} 
                                            onChange={(e) => updateEvent(currentTripId, dIdx, eIdx, 'location', e.target.value)}
                                            className="w-full bg-transparent focus:outline-none border-b border-transparent focus:border-pink-200 text-blue-500 placeholder-blue-300 truncate"
                                            placeholder="è¼¸å…¥åœ°é»..."
                                        />
                                        <button 
                                            onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.location)}`, '_blank')}
                                            className="p-1 hover:bg-blue-50 rounded-full"
                                        >
                                            <ExternalLink className="w-3 h-3" />
                                        </button>
                                    </div>
                                    <textarea 
                                        value={event.note || ''} 
                                        onChange={(e) => updateEvent(currentTripId, dIdx, eIdx, 'note', e.target.value)}
                                        className="w-full text-xs text-slate-400 focus:outline-none bg-transparent resize-none focus:text-slate-600"
                                        placeholder="å‚™è¨»..."
                                        rows="1"
                                        onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }}
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    });

    const NewPlannerTab = memo(({ trips, selectedTripId, setSelectedTripId, deleteTrip, onAddTrip, loading, loadingStatus, updateEvent }) => {
        const [showModal, setShowModal] = useState(false);
        const [form, setForm] = useState({ location: 'åŒ—æµ·é“', days: 5, startDate: '2026-03-04' });

        const handleCreate = () => {
            onAddTrip(form.location, form.days, form.startDate, () => setShowModal(false));
        };

        if (!trips || trips.length === 0) {
            return (
                <div className="flex flex-col items-center justify-center h-[70vh] px-4 text-center animate-in fade-in">
                    <div className="bg-white p-8 rounded-3xl shadow-lg border border-pink-100 max-w-sm w-full">
                        <div className="w-16 h-16 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <Sparkles className="w-8 h-8 text-pink-500" />
                        </div>
                        <h2 className="text-xl font-bold text-slate-800 mb-2">é–‹å§‹è¦åŠƒèœœæœˆ</h2>
                        <p className="text-slate-500 mb-6 text-sm">ç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œè®“ AI ç‚ºä½ å€‘å¯«ä¸‹ç¬¬ä¸€ç¯‡ç« å§ï¼</p>
                        
                        <div className="space-y-3 text-left mb-6">
                            <div>
                                <label className="text-xs text-slate-400 font-bold ml-1">åœ°é»</label>
                                <input type="text" value={form.location} onChange={e=>setForm({...form, location: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl text-sm border focus:border-pink-300 outline-none" />
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1">
                                    <label className="text-xs text-slate-400 font-bold ml-1">å¤©æ•¸</label>
                                    <input type="number" value={form.days} onChange={e=>setForm({...form, days: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl text-sm border focus:border-pink-300 outline-none" />
                                </div>
                                <div className="flex-1">
                                    <label className="text-xs text-slate-400 font-bold ml-1">æ—¥æœŸ</label>
                                    <input type="date" value={form.startDate} onChange={e=>setForm({...form, startDate: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl text-sm border focus:border-pink-300 outline-none" />
                                </div>
                            </div>
                        </div>

                        <button onClick={handleCreate} disabled={loading} className="w-full bg-pink-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-pink-600 transition disabled:opacity-50">
                            {loading ? <><Loader2 className="animate-spin w-4 h-4"/> {loadingStatus || "ç”Ÿæˆä¸­..."}</> : "AI ç”Ÿæˆè¡Œç¨‹"}
                        </button>
                    </div>
                </div>
            );
        }

        const currentTrip = trips.find(t => t.id === selectedTripId) || trips[0];

        return (
            <div className="animate-in fade-in pb-20">
                <div className="flex items-center gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar">
                    {trips.map(trip => (
                        <button key={trip.id} onClick={() => setSelectedTripId(trip.id)} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 transition border ${selectedTripId === trip.id ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-slate-600 border-slate-200'}`}>
                            {trip.location}
                            {selectedTripId === trip.id && <X className="w-3 h-3 ml-1 opacity-70 hover:opacity-100" onClick={(e)=>{e.stopPropagation(); if(confirm('åˆªé™¤æ­¤è¡Œç¨‹?')) deleteTrip(trip.id)}} />}
                        </button>
                    ))}
                    <button onClick={() => setShowModal(true)} className="flex-shrink-0 px-3 py-2 rounded-full bg-white border border-dashed border-pink-300 text-pink-500 text-sm font-medium flex items-center gap-1">
                        <Plus className="w-4 h-4" />
                    </button>
                </div>

                <div className="space-y-4">
                    {currentTrip?.itineraryData?.map((day, idx) => (
                        <DaySection 
                            key={`${currentTrip.id}-${idx}`}
                            day={day}
                            dIdx={idx}
                            currentTripId={currentTrip.id}
                            updateEvent={updateEvent}
                        />
                    ))}
                </div>

                {showModal && (
                    <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
                        <div className="bg-white p-6 rounded-3xl w-full max-w-sm">
                            <h3 className="font-bold text-lg mb-4">æ–°å¢åŸå¸‚è¡Œç¨‹</h3>
                            <div className="space-y-3 mb-4">
                                <input type="text" placeholder="åŸå¸‚" value={form.location} onChange={e=>setForm({...form, location: e.target.value})} className="w-full p-3 border rounded-xl" />
                                <input type="number" placeholder="å¤©æ•¸" value={form.days} onChange={e=>setForm({...form, days: e.target.value})} className="w-full p-3 border rounded-xl" />
                                <input type="date" value={form.startDate} onChange={e=>setForm({...form, startDate: e.target.value})} className="w-full p-3 border rounded-xl" />
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setShowModal(false)} disabled={loading} className="flex-1 p-3 bg-slate-100 rounded-xl text-slate-500">å–æ¶ˆ</button>
                                <button onClick={handleCreate} disabled={loading} className="flex-1 p-3 bg-pink-500 text-white rounded-xl font-bold flex justify-center items-center gap-2">
                                    {loading ? <Loader2 className="animate-spin w-4 h-4"/> : "ç”Ÿæˆ"}
                                </button>
                            </div>
                            {loading && <p className="text-xs text-pink-500 text-center mt-2 animate-pulse">{loadingStatus}</p>}
                        </div>
                    </div>
                )}
            </div>
        );
    });

    const FoodTab = memo(({ getNearbyFood, getNearbySpots, loading, nearbyFood, foodStatus, exploreMode, setExploreMode }) => (
      <div className="space-y-4 animate-in slide-in-from-right duration-300">
        <div className="bg-white p-5 rounded-2xl shadow-sm space-y-3 text-center relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-300 to-orange-500"></div>
          <h2 className="text-lg font-bold flex items-center justify-center gap-2 text-orange-600"><MapPin className="w-5 h-5" /> æ¢ç´¢å‘¨é‚Š (ç¾é£Ÿ & æ™¯é»)</h2>
          
          <div className="flex gap-2">
            <button 
                onClick={() => { setExploreMode('food'); getNearbyFood(); }}
                disabled={loading}
                className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-sm transition active:scale-95 ${exploreMode === 'food' ? 'bg-orange-500 text-white' : 'bg-orange-100 text-orange-600'}`}
            >
                {loading && exploreMode === 'food' ? <Loader2 className="animate-spin w-4 h-4"/> : <Utensils className="w-4 h-4" />} 
                æ‰¾ç¾é£Ÿ
            </button>
            <button 
                onClick={() => { setExploreMode('spots'); getNearbySpots(); }}
                disabled={loading}
                className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-sm transition active:scale-95 ${exploreMode === 'spots' ? 'bg-purple-500 text-white' : 'bg-purple-100 text-purple-600'}`}
            >
                {loading && exploreMode === 'spots' ? <Loader2 className="animate-spin w-4 h-4"/> : <Camera className="w-4 h-4" />} 
                æ‰¾æ™¯é»
            </button>
          </div>
          
          {foodStatus && <p className="text-xs text-slate-500 font-medium animate-pulse">{foodStatus}</p>}
        </div>

        <div className="grid gap-3">
          {nearbyFood.map((item, idx) => (
            <div key={idx} className={`bg-white p-3 rounded-2xl shadow-sm flex gap-3 border-l-4 ${item.type === 'spot' ? 'border-purple-400' : 'border-orange-400'} animate-in slide-in-from-bottom-2`}>
              <div className="flex-grow">
                <div className="flex justify-between items-start">
                  <h3 className="font-bold text-slate-800 flex items-center gap-2">
                      {item.name}
                      {item.type === 'spot' && <Camera className="w-3 h-3 text-purple-400"/>}
                  </h3>
                  {item.rating && <span className="text-orange-500 font-extrabold flex items-center gap-1 text-sm">â˜… {item.rating}</span>}
                </div>
                <p className="text-xs text-slate-500 mb-1">{item.subType || item.type} Â· <span className="italic">ã€Œ{item.reason || item.description}ã€</span></p>
                {item.tips && <p className="text-xs text-purple-600 bg-purple-50 p-1 rounded inline-block mb-1">ğŸ’¡ {item.tips}</p>}
                <button 
                    onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name + ' ' + (item.address || ''))}`, '_blank')}
                    className={`text-xs flex items-center gap-1 hover:underline px-2 py-1 rounded-full w-fit mt-2 ${item.type === 'spot' ? 'text-purple-600 bg-purple-50' : 'text-blue-500 bg-blue-50'}`}
                >
                  <MapPin className="w-3 h-3" /> å°èˆªå‰å¾€
                </button>
              </div>
            </div>
          ))}
          {nearbyFood.length === 0 && !loading && (
             <div className="text-center text-slate-400 py-10 bg-white rounded-2xl border border-dashed border-slate-200">
                 é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¢ç´¢
             </div>
          )}
        </div>
      </div>
    ));

    const PrepTab = memo(({ packingList, setPackingList, deletePackingItem, newItemText, setNewItemText, addPackingItem, memos, setMemos, suggestPackingItems, suggestingItems, weatherInfos, addWeatherLocation, isAddingWeather, deleteWeatherLocation, onGenerateJournal, journalLoading }) => {
      const [weatherCity, setWeatherCity] = useState('');
      const [journalKeywords, setJournalKeywords] = useState('');

      return (
        <div className="space-y-6 animate-in slide-in-from-right duration-300">
          <section>
             <div className="flex justify-between items-center mb-3">
               <h2 className="text-lg font-bold flex items-center gap-2 text-blue-600"><ThermometerSun className="w-5 h-5" /> åŸå¸‚æ°£å€™æŒ‡å—</h2>
             </div>
             {weatherInfos && weatherInfos.map(info => (
                <WeatherCard key={info.id} info={info} onDelete={deleteWeatherLocation} />
             ))}
             <div className="flex gap-2 bg-white p-3 rounded-2xl shadow-sm border border-blue-100">
               <input 
                 type="text" 
                 placeholder="è¼¸å…¥åŸå¸‚ (å¦‚: äº¬éƒ½)" 
                 value={weatherCity}
                 onChange={e => setWeatherCity(e.target.value)}
                 className="flex-grow p-2 text-sm border rounded-xl focus:outline-none focus:border-blue-400"
               />
               <button 
                 onClick={() => { if(weatherCity) { addWeatherLocation(weatherCity); setWeatherCity(''); }}}
                 disabled={isAddingWeather || !weatherCity}
                 className="bg-blue-100 text-blue-600 px-4 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-blue-200 disabled:opacity-50"
               >
                 {isAddingWeather ? <Loader2 className="w-4 h-4 animate-spin"/> : <Plus className="w-4 h-4"/>} æ–°å¢
               </button>
             </div>
          </section>

          <section className="bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold flex items-center gap-2 text-green-700"><ClipboardList className="w-5 h-5" /> è¡Œå‰æº–å‚™æ¸…å–®</h2>
              <button onClick={suggestPackingItems} disabled={suggestingItems} className="bg-green-50 text-green-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 hover:bg-green-100 transition disabled:opacity-50">
                {suggestingItems ? <Loader2 className="w-3 h-3 animate-spin" /> : <Sparkles className="w-3 h-3" />} AI æ¨è–¦
              </button>
            </div>
            <div className="space-y-2 mb-4">
              {packingList.map(item => (
                <div key={item.id} className="flex items-center gap-3 group">
                  <button onClick={() => setPackingList(packingList.map(i => i.id === item.id ? {...i, checked: !i.checked} : i))} className={`w-5 h-5 rounded border-2 flex items-center justify-center transition ${item.checked ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300'}`}>{item.checked && <CheckCircle className="w-3 h-3" />}</button>
                  <span className={`flex-grow text-sm transition ${item.checked ? 'line-through text-slate-400' : 'text-slate-700'}`}>{item.text}</span>
                  <button onClick={() => deletePackingItem(item.id)} className="text-slate-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition"><Trash2 className="w-4 h-4" /></button>
                </div>
              ))}
            </div>
            <div className="flex gap-2">
              <input type="text" value={newItemText} onChange={(e) => setNewItemText(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && addPackingItem()} placeholder="æ–°å¢ç‰©å“..." className="flex-grow p-2 text-sm border rounded-xl focus:outline-none focus:border-green-400" />
              <button onClick={addPackingItem} className="bg-green-100 text-green-600 p-2 rounded-xl hover:bg-green-200 transition"><Plus className="w-5 h-5" /></button>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold flex items-center gap-2 text-purple-700"><Edit2 className="w-5 h-5" /> æ—…éŠå‚™å¿˜éŒ„</h2>
              <button onClick={() => setMemos([...memos, { id: Date.now(), text: '' }])} className="p-2 bg-purple-100 text-purple-600 rounded-lg hover:bg-purple-200 transition"><Plus className="w-4 h-4" /></button>
            </div>
            
            <div className="bg-purple-50 p-4 rounded-xl mb-4 border border-purple-100">
                <h3 className="text-xs font-bold text-purple-600 mb-2 flex items-center gap-1"><Sparkles className="w-3 h-3"/> AI èœœæœˆæ—¥è¨˜åŠ©æ‰‹</h3>
                <div className="flex gap-2">
                    <input 
                        type="text" 
                        placeholder="ä»Šå¤©çš„å¿ƒæƒ…/é—œéµå­— (ä¾‹: å°æ¨½é‹æ²³, å¥½å†·, è¶…æµªæ¼«)" 
                        value={journalKeywords}
                        onChange={(e) => setJournalKeywords(e.target.value)}
                        className="flex-grow p-2 text-sm border rounded-lg focus:outline-none focus:border-purple-400"
                    />
                    <button 
                        onClick={() => { if(journalKeywords) { onGenerateJournal(journalKeywords); setJournalKeywords(''); }}}
                        disabled={journalLoading || !journalKeywords}
                        className="bg-purple-500 text-white px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap hover:bg-purple-600 disabled:opacity-50"
                    >
                        {journalLoading ? <Loader2 className="w-4 h-4 animate-spin"/> : "ç”Ÿæˆæ—¥è¨˜"}
                    </button>
                </div>
            </div>

            <div className="space-y-3">
              {memos.map(memo => (
                <div key={memo.id} className="relative group">
                  <textarea placeholder="è¼¸å…¥ç­†è¨˜..." value={memo.text} onChange={(e) => setMemos(memos.map(m => m.id === memo.id ? {...m, text: e.target.value} : m))} className="w-full p-3 bg-purple-50/50 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-200 resize-none min-h-[80px]" />
                  <button onClick={() => setMemos(memos.filter(m => m.id !== memo.id))} className="absolute top-2 right-2 p-1 text-purple-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition bg-white rounded-full shadow-sm"><Trash2 className="w-3 h-3" /></button>
                </div>
              ))}
            </div>
          </section>
        </div>
      );
    });

    const CouponsTab = memo(({ coupons, setCoupons, showAddCoupon, setShowAddCoupon, newCouponForm, setNewCouponForm, handleImageUpload, currency, handleCurrencyTwd, handleCurrencyJpy }) => {
       const [calcPrice, setCalcPrice] = useState('');
       const [isTaxIncluded, setIsTaxIncluded] = useState(true);
       const [isTaxFree, setIsTaxFree] = useState(false);
       const [discountPercent, setDiscountPercent] = useState('');
       const basePrice = parseFloat(calcPrice) || 0;
       let preDiscountPrice = basePrice;
       if (isTaxIncluded) { if (isTaxFree) preDiscountPrice = basePrice / 1.1; } else { if (!isTaxFree) preDiscountPrice = basePrice * 1.1; }
       const finalJpy = Math.round(preDiscountPrice * (1 - (parseFloat(discountPercent)||0) / 100));
       const finalTwd = Math.round(finalJpy * EXCHANGE_RATE);

       return (
           <div className="space-y-4 animate-in slide-in-from-right duration-300">
             <div className="flex justify-between items-center">
                <h2 className="text-lg font-bold flex items-center gap-2 text-red-600"><Ticket className="w-5 h-5" /> å„ªæƒ åˆ¸éŒ¢åŒ…</h2>
                <button onClick={() => setShowAddCoupon(true)} className="bg-red-100 text-red-600 px-3 py-1.5 rounded-full text-sm font-bold flex items-center gap-1"><Plus className="w-4 h-4"/> æ–°å¢</button>
             </div>
             {showAddCoupon && (
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-red-100 space-y-2">
                    <input type="text" placeholder="æ¨™é¡Œ" className="w-full p-2 border rounded" value={newCouponForm.title} onChange={e=>setNewCouponForm({...newCouponForm, title: e.target.value})} />
                    <input type="text" placeholder="ä»£ç¢¼" className="w-full p-2 border rounded" value={newCouponForm.code} onChange={e=>setNewCouponForm({...newCouponForm, code: e.target.value})} />
                    <input type="file" onChange={handleImageUpload} className="text-sm" />
                    <div className="flex gap-2">
                        <button onClick={()=>setShowAddCoupon(false)} className="flex-1 p-2 bg-slate-100 rounded">å–æ¶ˆ</button>
                        <button onClick={()=>{ setCoupons(p=>[...p, {id: Date.now(), ...newCouponForm}]); setShowAddCoupon(false); }} className="flex-1 p-2 bg-red-500 text-white rounded">å„²å­˜</button>
                    </div>
                </div>
             )}
             {coupons.map(c => (
                 <div key={c.id} className="bg-white p-4 rounded-2xl border border-red-100 relative">
                    <button onClick={()=>setCoupons(p=>p.filter(x=>x.id!==c.id))} className="absolute top-2 right-2 text-slate-300"><Trash2 className="w-4 h-4"/></button>
                    {c.image && <img src={c.image} className="w-full h-32 object-cover rounded-lg mb-2" />}
                    <h3 className="font-bold">{c.title}</h3>
                    <p className="font-mono text-red-500 bg-red-50 p-2 text-center rounded mt-2 select-all">{c.code}</p>
                 </div>
             ))}
             <hr className="border-slate-200 my-4"/>
             <div className="bg-white rounded-2xl p-5 shadow-sm border border-blue-100">
                <h3 className="font-bold mb-4 flex items-center gap-2 text-slate-700"><Calculator className="w-5 h-5 text-blue-500" /> è³¼ç‰©æŠ˜æ‰£è¨ˆç®—æ©Ÿ</h3>
                <div className="space-y-4">
                    <div><label className="text-xs text-slate-500 font-bold ml-1">å•†å“æ¨™åƒ¹ (JPY)</label><input type="number" value={calcPrice} onChange={e => setCalcPrice(e.target.value)} placeholder="0" className="w-full p-3 bg-slate-50 rounded-xl text-lg font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-200" /></div>
                    <div className="flex justify-between gap-2">
                        <button onClick={() => setIsTaxIncluded(!isTaxIncluded)} className={`flex-1 py-2 px-3 rounded-xl text-xs font-bold transition flex items-center justify-center gap-1 border ${isTaxIncluded ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-slate-400 border-slate-200'}`}>{isTaxIncluded ? <CheckCircle className="w-3 h-3"/> : <div className="w-3 h-3 rounded-full border border-current"/>} æ¨™åƒ¹å«ç¨…</button>
                        <button onClick={() => setIsTaxFree(!isTaxFree)} className={`flex-1 py-2 px-3 rounded-xl text-xs font-bold transition flex items-center justify-center gap-1 border ${isTaxFree ? 'bg-green-500 text-white border-green-500' : 'bg-white text-slate-400 border-slate-200'}`}>{isTaxFree ? <CheckCircle className="w-3 h-3"/> : <div className="w-3 h-3 rounded-full border border-current"/>} å…ç¨… (10%)</button>
                    </div>
                    <div className="flex items-center gap-3"><div className="flex-1"><label className="text-xs text-slate-500 font-bold ml-1">é¡å¤–æŠ˜æ‰£ %</label><div className="relative"><input type="number" value={discountPercent} onChange={e => setDiscountPercent(e.target.value)} placeholder="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold focus:outline-none focus:ring-2 focus:ring-red-200 text-red-500" /><Percent className="w-4 h-4 text-slate-400 absolute right-3 top-1/2 -translate-y-1/2" /></div></div></div>
                    <div className="bg-slate-800 rounded-xl p-4 text-white"><div className="flex justify-between items-end mb-2"><span className="text-xs text-slate-400">æœ€çµ‚å…¥æ‰‹åƒ¹</span><span className="text-2xl font-bold text-yellow-400">Â¥ {finalJpy.toLocaleString()}</span></div><div className="flex justify-between items-center pt-2 border-t border-slate-700"><span className="text-xs text-slate-400">é ä¼°å°å¹£</span><span className="font-mono">NT$ {finalTwd.toLocaleString()}</span></div></div>
                </div>
             </div>
             <div className="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 mt-4"><h3 className="font-bold mb-3 flex items-center gap-2 text-sm text-slate-700"><RefreshCw className="w-4 h-4 text-slate-400" /> ç°¡æ˜“é›™å‘æ›ç®— (åŒ¯ç‡ {EXCHANGE_RATE})</h3><div className="flex gap-3 items-center"><div className="flex-1 relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-slate-400">TWD</span><input type="number" value={currency.twd} onChange={(e) => handleCurrencyTwd(e.target.value)} className="w-full pl-12 p-2 bg-slate-50 rounded-xl focus:outline-none text-sm font-medium" /></div><span className="text-slate-400">â‰ˆ</span><div className="flex-1 relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-blue-500">JPY</span><input type="number" value={currency.jpy} onChange={(e) => handleCurrencyJpy(e.target.value)} className="w-full pl-12 p-2 bg-blue-50 text-blue-700 font-bold rounded-xl text-sm focus:outline-none" /></div></div></div>
           </div>
       );
    });

    const TranslateTab = memo(({ transInput, setTransInput, handleTranslate, translating, transResult }) => (
        <div className="space-y-6 animate-in slide-in-from-right duration-300">
          <div className="bg-indigo-600 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden">
             <Languages className="absolute right-[-20px] top-[-20px] w-32 h-32 opacity-10" />
             <h2 className="text-xl font-bold mb-2 flex items-center gap-2">AI éš¨èº«æ—¥èªç¿»è­¯</h2>
             <p className="text-indigo-100 text-sm">è¼¸å…¥ä¸­æ–‡ï¼Œç«‹åˆ»è½‰ç‚ºè‡ªç„¶ã€æœ‰ç¦®è²Œçš„æ—¥èªã€‚</p>
          </div>
          <div className="bg-white rounded-2xl shadow-sm p-4 border border-slate-100 space-y-4">
            <div><label className="text-xs font-bold text-slate-400 mb-1 block">ä¸­æ–‡è¼¸å…¥</label><textarea value={transInput} onChange={(e) => setTransInput(e.target.value)} placeholder="ä¾‹å¦‚ï¼šè«‹å•é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ / æˆ‘å°è¦å­éæ•ã€‚" className="w-full p-4 bg-slate-50 rounded-xl text-base focus:outline-none focus:ring-2 focus:ring-indigo-200 resize-none h-24"/></div>
            <button onClick={handleTranslate} disabled={translating || !transInput} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-indigo-700 transition disabled:opacity-50">{translating ? <Loader2 className="animate-spin w-5 h-5" /> : <Sparkles className="w-5 h-5" />} ç¿»è­¯æˆæ—¥èª</button>
          </div>
          {transResult && (
            <div className="bg-white rounded-2xl shadow-sm p-6 border-l-4 border-indigo-500 animate-in fade-in slide-in-from-bottom-2">
              <div className="mb-4"><p className="text-xs text-slate-400 font-bold mb-1">æ—¥èª (Polite)</p><p className="text-2xl font-bold text-slate-800">{transResult.japanese}</p></div>
              <div className="bg-slate-50 p-3 rounded-lg"><p className="text-xs text-slate-400 font-bold mb-1">ç™¼éŸ³ (Romaji)</p><p className="text-sm font-mono text-indigo-600 font-medium">{transResult.romaji}</p></div>
            </div>
          )}
        </div>
    ));

    // --- MAIN APP ---
    const App = () => {
      const [activeTab, setActiveTab] = useState('planner');
      const [status, setStatus] = useState('loading');
      const [errorMsg, setErrorMsg] = useState('');
      const [user, setUser] = useState(null);
      
      const [trips, setTrips] = useState([]);
      const [selectedTripId, setSelectedTripId] = useState(null);
      
      const [memos, setMemos] = useState([]);
      const [packingList, setPackingList] = useState([]);
      const [coupons, setCoupons] = useState([]);
      const [weatherInfos, setWeatherInfos] = useState([]);
      
      const [newItemText, setNewItemText] = useState('');
      const [suggestingItems, setSuggestingItems] = useState(false);
      const [isAddingWeather, setIsAddingWeather] = useState(false);
      const [showAddCoupon, setShowAddCoupon] = useState(false);
      const [newCouponForm, setNewCouponForm] = useState({ title: '', code: '', description: '', image: null });
      const [nearbyFood, setNearbyFood] = useState([]);
      const [foodLoading, setFoodLoading] = useState(false);
      const [foodStatus, setFoodStatus] = useState('');
      const [transInput, setTransInput] = useState('');
      const [transResult, setTransResult] = useState(null);
      const [translating, setTranslating] = useState(false);
      const [currency, setCurrency] = useState({ twd: 100, jpy: 0 });
      const [exploreMode, setExploreMode] = useState('food');
      
      const [tripLoading, setTripLoading] = useState(false);
      const [tripStatus, setTripStatus] = useState('');
      const [journalLoading, setJournalLoading] = useState(false);

      const isRemoteUpdate = useRef(false);
      const saveTimeoutRef = useRef(null);

      useEffect(() => {
        document.getElementById('initial-loader')?.remove();
        setCurrency(prev => ({ ...prev, jpy: Math.round(prev.twd / EXCHANGE_RATE) }));
        
        signInAnonymously(auth).catch(e => {
            console.error(e);
            setStatus('error');
            setErrorMsg(`ç™»å…¥å¤±æ•—: ${e.code}`);
        });

        const unsubAuth = onAuthStateChanged(auth, u => {
            if(u) {
                setUser(u);
                const docRef = doc(db, 'artifacts', appId, 'public', 'shared_data');
                onSnapshot(docRef, (snap) => {
                    setStatus('ready');
                    if (snap.exists()) {
                        const d = snap.data();
                        isRemoteUpdate.current = true;
                        setTrips(d.trips || []);
                        setPackingList(d.packingList || []);
                        setMemos(d.memos || []);
                        setCoupons(d.coupons || []);
                        setWeatherInfos(d.weatherInfos || []);
                        
                        setSelectedTripId(prev => {
                            if (prev && d.trips?.find(t => t.id === prev)) return prev;
                            return d.trips?.[0]?.id || null;
                        });
                        setTimeout(() => { isRemoteUpdate.current = false; }, 100);
                    } else {
                        setTrips([]);
                    }
                }, err => {
                    console.error(err);
                    setStatus('error');
                    setErrorMsg("ç„¡æ³•è®€å–è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥æ¬Šé™");
                });
            }
        });
        return () => unsubAuth();
      }, []);

      const saveToCloud = useCallback((dataToSave) => {
        if(!user) return;
        setDoc(doc(db, 'artifacts', appId, 'public', 'shared_data'), dataToSave, { merge: true })
          .catch(e => console.error("Save failed", e));
      }, [user]);

      useEffect(() => {
          if (status === 'ready' && !isRemoteUpdate.current) {
              if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
              saveTimeoutRef.current = setTimeout(() => {
                 saveToCloud({ trips, packingList, memos, coupons, weatherInfos });
              }, 1500);
          }
      }, [trips, packingList, memos, coupons, weatherInfos, status, saveToCloud]);

      const handleAddTrip = async (loc, days, start, callback) => {
          setTripLoading(true);
          setTripStatus("AI æ­£åœ¨è¦åŠƒè¡Œç¨‹...");
          try {
              const result = await fetchGemini(
                  `è¦åŠƒ${start}é–‹å§‹çš„${days}å¤©${loc}èœœæœˆè¡Œç¨‹...`, 
                  `ä½ æ˜¯ä¸€ä½æ—¥æœ¬æ—…éŠå°ˆå®¶ã€‚è¼¸å‡º JSON æ ¼å¼: [{day:1, date:"...", title:"...", events:[{time:"...", activity:"...", location:"...", note:"..."}]}]`,
                  setTripStatus
              );
              
              const newTrip = { id: Date.now(), location: loc, days, startDate: start, itineraryData: result };
              setTrips(prev => [...prev, newTrip]);
              setSelectedTripId(newTrip.id);
              callback && callback();
          } catch(e) {
              alert("ç”Ÿæˆå¤±æ•—: " + e.message);
          } finally {
              setTripLoading(false);
          }
      };
      
      const updateEvent = useCallback((tripId, dayIdx, eventIdx, field, value) => {
        setTrips(prev => prev.map(trip => {
          if (trip.id === tripId) {
            if (!trip.itineraryData || !trip.itineraryData[dayIdx] || !trip.itineraryData[dayIdx].events) return trip;
            const newData = [...trip.itineraryData];
            const newDay = {...newData[dayIdx]};
            const newEvents = [...newDay.events];
            newEvents[eventIdx] = {...newEvents[eventIdx], [field]: value};
            newDay.events = newEvents;
            newData[dayIdx] = newDay;
            return { ...trip, itineraryData: newData };
          }
          return trip;
        }));
      }, []);

      const deleteTrip = (id) => {
          setTrips(prev => prev.filter(t => t.id !== id));
          if(selectedTripId === id) setSelectedTripId(null);
      };

      const getNearbyFood = () => {
          if(!navigator.geolocation) return alert("ç„¡å®šä½æ¬Šé™");
          setFoodLoading(true);
          setFoodStatus("å®šä½ä¸­...");
          navigator.geolocation.getCurrentPosition(async pos => {
              const { latitude, longitude } = pos.coords;
              setFoodStatus(`å®šä½æˆåŠŸï¼Œæœå°‹å‘¨é‚Šç¾é£Ÿ...`);
              try {
                  const res = await fetchGemini(`æ¨è–¦ (${latitude},${longitude}) é™„è¿‘5å®¶ç¾é£Ÿã€‚ è«‹åš´æ ¼è¼¸å‡º JSON é™£åˆ—ï¼Œæ ¼å¼: [{name, rating, type, reason, address, tips}]`);
                  const enhancedRes = (Array.isArray(res) ? res : []).map(item => ({ ...item, type: 'food', subType: item.type }));
                  setNearbyFood(enhancedRes);
                  setFoodStatus("");
              } catch(e){ 
                  alert("æœå°‹å¤±æ•—: " + e.message); 
                  setFoodStatus("æœå°‹å¤±æ•—");
              } finally { 
                  setFoodLoading(false); 
              }
          }, (err) => {
              setFoodLoading(false);
              setFoodStatus("å®šä½å¤±æ•—");
              alert("å®šä½å¤±æ•—: " + err.message);
          });
      };
      
      const getNearbySpots = () => {
          if(!navigator.geolocation) return alert("ç„¡å®šä½æ¬Šé™");
          setFoodLoading(true);
          setFoodStatus("å®šä½ä¸­...");
          navigator.geolocation.getCurrentPosition(async pos => {
              const { latitude, longitude } = pos.coords;
              setFoodStatus(`å®šä½æˆåŠŸï¼Œæœå°‹æµªæ¼«æ™¯é»...`);
              try {
                  const res = await fetchGemini(`æ¨è–¦ (${latitude},${longitude}) é™„è¿‘3å€‹é©åˆèœœæœˆæ‹ç…§æˆ–æµªæ¼«ç´„æœƒçš„æ™¯é»ã€‚ è«‹åš´æ ¼è¼¸å‡º JSON é™£åˆ—ï¼Œæ ¼å¼: [{name, rating, type: "spot", description, address, tips}]`);
                  const enhancedRes = (Array.isArray(res) ? res : []).map(item => ({ ...item, type: 'spot', subType: 'æ™¯é»' }));
                  setNearbyFood(enhancedRes); 
                  setFoodStatus("");
              } catch(e){ 
                  alert("æœå°‹å¤±æ•—: " + e.message); 
                  setFoodStatus("æœå°‹å¤±æ•—");
              } finally { 
                  setFoodLoading(false); 
              }
          }, (err) => {
              setFoodLoading(false);
              setFoodStatus("å®šä½å¤±æ•—");
              alert("å®šä½å¤±æ•—: " + err.message);
          });
      };
      
      const handleGenerateJournal = async (keywords) => {
          setJournalLoading(true);
          try {
              const res = await fetchGemini(
                  `è«‹æ ¹æ“šé—œéµå­—ã€Œ${keywords}ã€å¯«ä¸€ç¯‡ç¹é«”ä¸­æ–‡çš„èœœæœˆæ—¥è¨˜ï¼Œèªæ°£æµªæ¼«ã€æº«é¦¨ï¼Œç´„50-80å­—ã€‚è¼¸å‡º JSON æ ¼å¼: { "content": "æ—¥è¨˜å…§å®¹..." }`
              );
              if (res && res.content) {
                  const newMemo = { id: Date.now(), text: res.content };
                  setMemos(prev => [...prev, newMemo]);
              }
          } catch (e) {
              alert("ç”Ÿæˆå¤±æ•—");
          } finally {
              setJournalLoading(false);
          }
      };

      return (
        <div className="min-h-screen pb-24 font-sans">
          <header className="bg-white border-b p-4 text-center sticky top-0 z-50 shadow-sm flex justify-between items-center px-6">
             <div className="flex items-center gap-2">
                 <Heart className="text-pink-500 fill-pink-500 w-6 h-6"/>
                 <h1 className="font-bold text-lg text-slate-800">èœœæœˆç®¡å®¶</h1>
             </div>
             
             {status === 'loading' && <div className="flex items-center gap-2 text-xs text-slate-400"><Loader2 className="w-3 h-3 animate-spin"/> é€£ç·šä¸­...</div>}
             {status === 'ready' && <div className="flex items-center gap-2 text-xs text-green-500"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"/> å·²é€£ç·š</div>}
             {status === 'error' && <button onClick={()=>window.location.reload()} className="flex items-center gap-1 text-xs text-red-500 bg-red-50 px-2 py-1 rounded"><AlertCircle className="w-3 h-3"/> é‡è©¦</button>}
          </header>

          <main className="max-w-4xl mx-auto p-4">
            {status === 'error' && (
                <div className="bg-red-100 border border-red-200 text-red-700 p-4 rounded-xl mb-4 text-center">
                    <p className="font-bold">é€£ç·šç™¼ç”ŸéŒ¯èª¤</p>
                    <p className="text-sm">{errorMsg}</p>
                    <p className="text-xs mt-2 text-red-500">è«‹ç¢ºèª Firebase Console > Authentication > Sign-in method > Anonymous å·²é–‹å•Ÿ</p>
                </div>
            )}

            {activeTab === 'planner' && <NewPlannerTab 
                trips={trips} 
                selectedTripId={selectedTripId} 
                setSelectedTripId={setSelectedTripId}
                deleteTrip={deleteTrip}
                onAddTrip={handleAddTrip}
                loading={tripLoading}
                loadingStatus={tripStatus}
                updateEvent={updateEvent}
            />}

            {activeTab === 'food' && <FoodTab 
                getNearbyFood={getNearbyFood} 
                getNearbySpots={getNearbySpots}
                loading={foodLoading} 
                nearbyFood={nearbyFood} 
                foodStatus={foodStatus}
                exploreMode={exploreMode}
                setExploreMode={setExploreMode}
            />}
            
            {activeTab === 'prep' && <PrepTab 
                packingList={packingList} setPackingList={setPackingList} deletePackingItem={(id)=>setPackingList(p=>p.filter(i=>i.id!==id))}
                newItemText={newItemText} setNewItemText={setNewItemText} addPackingItem={()=>{if(newItemText){setPackingList(p=>[...p,{id:Date.now(),text:newItemText}]);setNewItemText('')}}}
                memos={memos} setMemos={setMemos}
                suggestPackingItems={async ()=>{
                    setSuggestingItems(true);
                    try { 
                        const res = await fetchGemini('æ—¥æœ¬èœœæœˆå¿…å‚™æ¸…å–® JSON string array'); 
                        const safeList = (Array.isArray(res) ? res : []).map(t => {
                            let textVal = t;
                            if (typeof t === 'object' && t !== null) textVal = t.item || t.text || t.name || JSON.stringify(t);
                            return {id: Math.random(), text: String(textVal), checked: false};
                        });
                        setPackingList(p=>[...p, ...safeList]); 
                    } finally { setSuggestingItems(false); }
                }} suggestingItems={suggestingItems}
                weatherInfos={weatherInfos} 
                addWeatherLocation={async (city, delId)=>{
                    if(delId) return setWeatherInfos(p=>p.filter(i=>i.id!==delId));
                    setIsAddingWeather(true);
                    try { 
                        const res = await fetchGemini(`${city} 3æœˆå¤©æ°£. JSON format: {location, temp, weather, clothing, notes}`); 
                        setWeatherInfos(p=>[...p, {id:Date.now(), ...res}]); 
                    } catch(e) {
                        alert("ç„¡æ³•ç²å–å¤©æ°£è³‡è¨Š: " + e.message);
                    } finally { setIsAddingWeather(false); }
                }} 
                deleteWeatherLocation={(id) => setWeatherInfos(p=>p.filter(i=>i.id!==id))}
                isAddingWeather={isAddingWeather}
                onGenerateJournal={handleGenerateJournal}
                journalLoading={journalLoading}
            />}

            {activeTab === 'coupons' && <CouponsTab 
                coupons={coupons} setCoupons={setCoupons}
                showAddCoupon={showAddCoupon} setShowAddCoupon={setShowAddCoupon}
                newCouponForm={newCouponForm} setNewCouponForm={setNewCouponForm}
                handleImageUpload={(e)=>{if(e.target.files[0]) setNewCouponForm(p=>({...p, image: URL.createObjectURL(e.target.files[0])}))}}
                currency={currency} 
                handleCurrencyTwd={(v)=>setCurrency({twd: v, jpy: Math.round(v/EXCHANGE_RATE)})}
                handleCurrencyJpy={(v)=>setCurrency({jpy: v, twd: Math.round(v*EXCHANGE_RATE)})}
            />}

            {activeTab === 'translate' && <TranslateTab 
                transInput={transInput} setTransInput={setTransInput}
                handleTranslate={async ()=>{
                    setTranslating(true);
                    try { const res = await fetchGemini(`Translate "${transInput}" to Japanese JSON {japanese, romaji}`); setTransResult(res); } finally { setTranslating(false); }
                }} translating={translating} transResult={transResult}
            />}
          </main>

          <nav className="fixed bottom-0 w-full bg-white/90 backdrop-blur border-t p-2 flex justify-between px-6 safe-area-bottom">
             {['planner', 'food', 'prep', 'coupons', 'translate'].map(tab => (
                 <button key={tab} onClick={() => setActiveTab(tab)} className={`flex flex-col items-center gap-1 ${activeTab===tab ? 'text-pink-600' : 'text-slate-400'}`}>
                    {tab==='planner' && <Calendar className="w-5 h-5"/>}
                    {tab==='food' && <Utensils className="w-5 h-5"/>}
                    {tab==='prep' && <ClipboardList className="w-5 h-5"/>}
                    {tab==='coupons' && <Ticket className="w-5 h-5"/>}
                    {tab==='translate' && <Languages className="w-5 h-5"/>}
                    <span className="text-[10px]">{tab==='planner'?'è¡Œç¨‹':tab==='food'?'æ¢ç´¢':tab==='prep'?'æº–å‚™':tab==='coupons'?'å„ªæƒ ':'ç¿»è­¯'}</span>
                 </button>
             ))}
          </nav>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>